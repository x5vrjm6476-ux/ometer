<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#0b0b0f" />
  <title>Vibe</title>

  <link rel="manifest" href="./manifest.webmanifest" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <link rel="apple-touch-icon" href="./icon-192.png" />

  <style>
    :root{
      --bg:#0b0b0f;
      --text:#f4f4f7;
      --muted:#a8a8b3;

      --panel: rgba(255,255,255,.045);
      --line: rgba(255,255,255,.09);

      --accent:#ff3b30;
      --good:#34c759;
      --warn:#ffcc00;
      --bad:#ff3b30;

      --safeTop: env(safe-area-inset-top);
      --safeBottom: env(safe-area-inset-bottom);
      --safeLeft: env(safe-area-inset-left);
      --safeRight: env(safe-area-inset-right);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background: var(--bg);
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, "SF Pro Display", "SF Pro Text", Segoe UI, Roboto, Helvetica, Arial;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      overscroll-behavior:none;
    }
    body::before{
      content:"";
      position:fixed;
      inset:-140px;
      background:
        radial-gradient(900px 620px at 12% -14%, color-mix(in srgb, var(--accent) 22%, transparent), transparent 58%),
        radial-gradient(820px 560px at 110% 18%, color-mix(in srgb, var(--accent) 14%, transparent), transparent 60%);
      pointer-events:none;
      z-index:-1;
      transform: translateZ(0);
    }

    button,input,select,textarea{font:inherit}
    .app{
      min-height:100%;
      padding:
        calc(14px + var(--safeTop))
        calc(14px + var(--safeRight))
        calc(120px + var(--safeBottom))
        calc(14px + var(--safeLeft));
      max-width: 640px;
      margin: 0 auto;
    }

    .loaderScreen{
      position:fixed;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      flex-direction:column;
      gap:12px;
      background: rgba(11,11,15,.94);
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
      z-index: 80;
    }
    .spinner{
      width: 38px; height: 38px; border-radius: 999px;
      border: 3px solid rgba(255,255,255,.14);
      border-top-color: color-mix(in srgb, var(--accent) 85%, #fff);
      animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .loaderText{font-weight:950; letter-spacing:.2px}
    .loaderSub{font-size:12px; color:var(--muted)}

    .toast{
      position:fixed;
      top: calc(12px + var(--safeTop));
      left: 50%;
      transform: translateX(-50%);
      width: min(640px, calc(100% - 20px));
      z-index: 60;
      display:none;
    }
    .toast.show{display:block}
    .toast .inner{
      background: rgba(17,17,26,.94);
      border: 1px solid rgba(255,255,255,.14);
      border-radius: 18px;
      padding: 12px 14px;
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      box-shadow: 0 18px 50px rgba(0,0,0,.55);
      display:flex; gap:10px; align-items:flex-start;
    }
    .toast .x{
      margin-left:auto; border:0; background: transparent; color: rgba(244,244,247,.75);
      cursor:pointer; height: 28px; width: 28px; border-radius: 10px;
    }
    .ppDot{
      width:10px; height:10px; border-radius:50%;
      background: var(--accent);
      box-shadow: 0 0 0 4px color-mix(in srgb, var(--accent) 12%, transparent);
      flex:0 0 auto;
      margin-top:3px;
    }
    .ppDot.good{background:var(--good); box-shadow:0 0 0 4px rgba(52,199,89,.12)}
    .ppDot.warn{background:var(--warn); box-shadow:0 0 0 4px rgba(255,204,0,.12)}
    .ppDot.bad{background:var(--bad); box-shadow:0 0 0 4px rgba(255,59,48,.12)}

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom: 12px;
    }
    .brand{display:flex; align-items:center; gap:10px; min-width:0}
    .logo{
      width:34px;height:34px;border-radius:12px;
      background: linear-gradient(180deg,
        color-mix(in srgb, var(--accent) 92%, #000),
        color-mix(in srgb, var(--accent) 45%, #000)
      );
      box-shadow: 0 18px 44px color-mix(in srgb, var(--accent) 18%, transparent);
      position:relative; flex:0 0 auto;
    }
    .logo:after{
      content:""; position:absolute; inset:10px; border-radius:10px;
      border:1px solid rgba(255,255,255,.22);
      background: rgba(0,0,0,.10);
    }
    .brandTitle{
      font-size:14px;
      font-weight:950;
      letter-spacing:.2px;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color:transparent;
    }
    .brandSub{display:none}

    .pill{
      height:36px;
      padding:0 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.02);
      display:flex; align-items:center; gap:8px;
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color:transparent;
      white-space:nowrap;
    }
    .pill:active{transform: scale(.985)}

    .card{
      background: rgba(17,17,26,.58);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 28px;
      padding: 18px;
      margin: 14px 0;
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
      box-shadow: 0 22px 70px rgba(0,0,0,.52);
    }
    .card.big{padding: 22px; min-height: 390px;}
    .divider{height:1px; background: rgba(255,255,255,.09); margin: 16px 0}

    .field{display:flex; flex-direction:column; gap:8px; margin: 12px 0}
    label{font-size:12px; color:var(--muted)}
    input[type="text"], select, textarea{
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      color: var(--text);
      padding: 12px 14px;
      outline:none;
    }
    input[type="text"], select{height: 52px}
    textarea{min-height: 96px; resize: vertical}
    input::placeholder, textarea::placeholder{color: rgba(168,168,179,.7)}

    .btn{
      height: 52px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.02);
      color: var(--text);
      padding: 0 14px;
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      display:flex; align-items:center; justify-content:center;
      gap:10px;
      font-weight: 900;
      letter-spacing:.15px;
    }
    .btn:active{transform: scale(.99)}
    .btn.primary{
      border-color: color-mix(in srgb, var(--accent) 60%, transparent);
      background:
        linear-gradient(180deg,
          color-mix(in srgb, var(--accent) 26%, transparent),
          color-mix(in srgb, var(--accent) 10%, transparent)
        );
      box-shadow: 0 18px 60px color-mix(in srgb, var(--accent) 12%, transparent);
    }
    .btn.ghost{background: rgba(0,0,0,.18)}
    .btn.danger{
      border-color: color-mix(in srgb, var(--bad) 65%, transparent);
      background:
        linear-gradient(180deg,
          color-mix(in srgb, var(--bad) 18%, transparent),
          color-mix(in srgb, var(--bad) 10%, transparent)
        );
    }
    .btn.small{height:44px; border-radius:16px; font-size:13px}
    .btn:disabled{opacity:.55; cursor:not-allowed}
    .row{display:flex; gap:10px}
    .row>*{flex:1}
    .smallText{font-size:12px; color:var(--muted); line-height:1.45}

    .moodHeader{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      margin-bottom: 10px;
    }
    .moodBigTitle{
      margin:0;
      font-size: 34px;
      font-weight: 980;
      letter-spacing: .2px;
      line-height: 1.03;
      text-transform: lowercase;
    }
    .moodBigSub{
      margin:10px 0 0;
      font-size: 12px;
      color: rgba(244,244,247,.78);
      line-height:1.35;
      text-transform: lowercase;
    }
    .datePick{
      flex:0 0 auto;
      height: 40px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      padding: 0 12px;
      display:flex;
      align-items:center;
      gap:8px;
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color:transparent;
      white-space:nowrap;
      font-weight: 900;
      letter-spacing:.1px;
    }
    .datePick .chev{opacity:.75}

    .statsRow2{
      margin-top: 16px;
      display:flex;
      gap:10px;
    }
    .statBox{
      flex:1;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      border-radius: 22px;
      padding: 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      min-width:0;
    }
    .statLeft{display:flex; align-items:center; gap:10px; min-width:0}
    .statDot{
      width:10px; height:10px; border-radius:50%;
      background: var(--accent);
      box-shadow: 0 0 0 4px color-mix(in srgb, var(--accent) 12%, transparent);
      flex:0 0 auto;
    }
    .statText{min-width:0}
    .statN{font-size:18px; font-weight:980; line-height:1}
    .statL{font-size:12px; color:var(--muted); margin-top:4px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}

    .meter{
      margin-top: 16px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      border-radius: 999px;
      height: 12px;
      overflow:hidden;
    }
    .meter>div{
      height:100%;
      width:0%;
      border-radius: 999px;
      background: linear-gradient(90deg,
        color-mix(in srgb, var(--accent) 95%, #000),
        color-mix(in srgb, var(--accent) 40%, #000)
      );
      transition: width .35s ease;
    }

    .recommend{
      margin-top: 18px;
      padding: 16px;
      border-radius: 22px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
    }
    .recommend .big{margin:0; font-size: 18px; font-weight: 980; text-transform: lowercase}
    .recommend .small{margin: 10px 0 0; font-size: 12px; color: rgba(244,244,247,.82); line-height:1.35}

    .peopleGrid{
      margin-top: 14px;
      display:flex;
      flex-wrap:wrap;
      gap:8px;
    }
    .personPill{
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.16);
      border-radius: 999px;
      padding: 8px 10px;
      display:flex;
      align-items:center;
      gap:8px;
      max-width: 100%;
    }
    .ppMiniDot{
      width:8px;height:8px;border-radius:50%;
      background: rgba(255,255,255,.25);
      box-shadow: 0 0 0 3px rgba(255,255,255,.05);
      flex:0 0 auto;
    }
    .ppMiniDot.good{background:var(--good); box-shadow:0 0 0 3px rgba(52,199,89,.12)}
    .ppMiniDot.warn{background:var(--warn); box-shadow:0 0 0 3px rgba(255,204,0,.12)}
    .ppMiniDot.bad{background:var(--bad); box-shadow:0 0 0 3px rgba(255,59,48,.12)}
    .ppName{
      font-size:12px;
      font-weight: 950;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 140px;
    }
    .ppVal{
      font-size:12px;
      color: rgba(244,244,247,.86);
      font-weight: 900;
      white-space:nowrap;
      text-transform: lowercase;
    }
    .ppMuted{opacity:.70}

    .checkinBar{
      position: fixed;
      left: 50%;
      bottom: calc(10px + var(--safeBottom));
      transform: translateX(-50%);
      width: min(640px, calc(100% - 20px));
      border-radius: 24px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(17,17,26,.82);
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
      box-shadow: 0 22px 76px rgba(0,0,0,.60);
      padding: 8px;
      z-index: 40;
      display:none;
    }
    .checkinBar .inner{display:flex; align-items:center; gap:10px}
    .checkinBar .text{min-width:0; flex:1}
    .checkinBar .t1{margin:0; font-size:13px; font-weight:980; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .checkinBar .t2{margin:2px 0 0; font-size:12px; color:var(--muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; text-transform: lowercase}
    .primaryBtn{
      height: 48px;
      border-radius: 18px;
      border: 1px solid color-mix(in srgb, var(--accent) 60%, transparent);
      background: color-mix(in srgb, var(--accent) 18%, transparent);
      padding: 0 14px;
      font-weight: 980;
      letter-spacing:.2px;
      color: var(--text);
      cursor:pointer;
      display:flex; align-items:center; gap:8px;
      user-select:none;
      -webkit-tap-highlight-color:transparent;
      flex:0 0 auto;
    }

    .modalBackdrop{
      position: fixed; inset:0;
      background: rgba(0,0,0,.62);
      display:none;
      align-items:flex-end;
      padding: 14px;
      padding-bottom: calc(14px + var(--safeBottom));
      z-index: 50;
    }
    .modalBackdrop.show{display:flex}
    .modal{
      width: min(640px, 100%);
      margin: 0 auto;
      background: rgba(17,17,26,.94);
      border: 1px solid rgba(255,255,255,.14);
      border-radius: 28px;
      padding: 14px;
      backdrop-filter: blur(22px);
      -webkit-backdrop-filter: blur(22px);
      box-shadow: 0 30px 100px rgba(0,0,0,.72);
    }
    .modalHead{
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
      margin-bottom:10px
    }
    .modalHead h3{margin:0; font-size:14px; font-weight:950}
    .modalHead p{margin:6px 0 0; font-size:12px; color:var(--muted); line-height:1.35}
    .xBtn{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      color: rgba(244,244,247,.90);
      height:36px; width:36px;
      border-radius: 14px;
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      display:flex; align-items:center; justify-content:center;
      font-size:16px;
      font-weight:900;
    }
    .xBtn:active{transform: scale(.99)}

    .sliderWrap{
      margin-top: 10px;
      padding: 12px;
      border-radius: 20px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.02);
    }
    .sliderTop{display:flex; align-items:flex-start; justify-content:space-between; gap:10px; margin-bottom:10px}
    .sliderVal{
      font-size: 18px;
      font-weight: 980;
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.22);
      min-width: 60px;
      text-align:center;
      text-transform: lowercase;
    }
    .sliderLabel{
      margin-top:6px;
      font-size:12px;
      color: rgba(244,244,247,.82);
      font-weight: 850;
      text-transform: lowercase;
    }
    .rangeShell{position:relative; height: 44px; display:flex; align-items:center}
    .rangeTrack{
      position:absolute; left:0; right:0;
      height: 12px; border-radius: 999px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      overflow:hidden;
    }
    .rangeFill{
      height:100%;
      width: 50%;
      border-radius: 999px;
      background: linear-gradient(90deg,
        color-mix(in srgb, var(--accent) 95%, #000),
        color-mix(in srgb, var(--accent) 35%, #000)
      );
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.18);
      transition: width .12s linear;
    }
    input[type="range"]{
      width:100%;
      height: 44px;
      background: transparent;
      outline:none;
      -webkit-appearance: none;
      appearance: none;
      position:relative;
      z-index: 2;
    }
    input[type="range"]::-webkit-slider-runnable-track{height: 12px; background: transparent; border-radius: 999px;}
    input[type="range"]::-webkit-slider-thumb{
      -webkit-appearance: none;
      width: 30px; height: 30px; border-radius: 999px;
      background: rgba(255,255,255,.94);
      border: 1px solid rgba(0,0,0,.22);
      box-shadow: 0 12px 36px rgba(0,0,0,.55);
      margin-top: -9px;
    }

    .pagerHead{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      margin-top: 6px;
    }
    .pagerTitle{font-size:12px; color:rgba(244,244,247,.82); font-weight:950}
    .navBtn{
      height:36px; width:36px; border-radius: 14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      cursor:pointer;
      display:flex; align-items:center; justify-content:center;
      user-select:none; -webkit-tap-highlight-color:transparent;
      font-weight:950;
    }
    .navBtn:active{transform:scale(.99)}
    .dayStrip{
      margin-top: 12px;
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:10px;
      touch-action: pan-y;
    }
    .dayCell{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.16);
      border-radius: 18px;
      padding: 10px;
      min-height: 76px;
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
    }
    .dayCell.active{
      border-color: color-mix(in srgb, var(--accent) 60%, transparent);
      background: color-mix(in srgb, var(--accent) 10%, transparent);
    }
    .dayTop{display:flex; justify-content:space-between; align-items:flex-start; gap:8px; font-weight: 950; font-size: 12px}
    .dayDots{display:flex; gap:6px}
    .miniDot{width:8px; height:8px; border-radius:50%; background: rgba(255,255,255,.22)}
    .miniDot.check{background: var(--good)}
    .miniDot.post{background: var(--accent)}

    .sectionHead{display:flex; align-items:flex-start; justify-content:space-between; gap:10px;}
    .sectionTitle{font-size:15px; font-weight:980; margin:0;}

    .post{
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.14);
      border-radius: 22px;
      padding: 14px;
      margin-top: 12px;
    }
    .postMeta{font-size:12px; color:var(--muted); display:flex; justify-content:space-between; gap:10px; align-items:center}
    .postMeta .right{display:flex; gap:8px; align-items:center}
    .postText{
      margin-top:8px;
      font-size:13px;
      line-height:1.4;
      white-space:pre-wrap;
      word-break:break-word;
      -webkit-user-select:text;
      user-select:text;
    }
    .postText a{
      color: color-mix(in srgb, var(--accent) 88%, #fff);
      text-decoration: none;
      border-bottom: 1px solid color-mix(in srgb, var(--accent) 35%, transparent);
    }
    .postText a:active{opacity:.8}

    .voteRow{margin-top: 12px; display:flex; align-items:center; gap:10px; flex-wrap:wrap}
    .iconBtn{
      height: 42px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      color: var(--text);
      padding: 0 14px;
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      display:flex;
      align-items:center;
      gap:10px;
      font-weight: 980;
      letter-spacing:.1px;
    }
    .scoreChip{
      height: 42px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      padding: 0 14px;
      display:flex; align-items:center;
      font-size: 12px;
      font-weight: 950;
      color: rgba(244,244,247,.90);
      text-transform: lowercase;
    }

    .replies{margin-top:10px; display:flex; flex-direction:column; gap:8px}
    .reply{
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.14);
      border-radius: 16px;
      padding: 10px;
    }
    .replyMeta{font-size:12px; color:var(--muted)}
    .replyText{
      margin-top:6px;
      font-size:13px;
      line-height:1.35;
      white-space:pre-wrap;
      word-break:break-word;
      -webkit-user-select:text;
      user-select:text;
    }
    .replyText a{
      color: color-mix(in srgb, var(--accent) 88%, #fff);
      text-decoration: none;
      border-bottom: 1px solid color-mix(in srgb, var(--accent) 35%, transparent);
    }

    .linkRow{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
      margin-top: 12px;
    }
    .codeBox{
      flex:1;
      min-width: 180px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      border-radius: 18px;
      padding: 12px 14px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
    }
    .codeBox .code{
      font-weight: 980;
      letter-spacing: .4px;
    }

    .onbTitle{
      margin:0;
      font-size: 22px;
      font-weight: 980;
      letter-spacing:.1px;
    }
    .onbSub{
      margin:8px 0 0;
      font-size: 12px;
      color: rgba(244,244,247,.75);
      line-height: 1.35;
    }
  </style>
</head>

<body>
  <div class="loaderScreen" id="loader">
    <div class="spinner"></div>
    <div class="loaderText">Vibe</div>
    <div class="loaderSub" id="loaderSub">verbindeâ€¦</div>
  </div>

  <div class="toast" id="toast">
    <div class="inner">
      <span class="ppDot" id="toastDot"></span>
      <div class="msg" id="toastMsg"></div>
      <button class="x" id="toastClose" aria-label="Schliessen">âœ•</button>
    </div>
  </div>

  <div class="app" id="swipeRoot">
    <div class="topbar">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div class="brandText" style="min-width:0">
          <div class="brandTitle" id="brandTitle">Vibe</div>
          <div class="brandSub" id="brandSub">â€”</div>
        </div>
      </div>

      <button class="pill" id="btnUser" title="Profil">
        <span>ðŸ‘¤</span><span id="meLabel">Gast</span>
      </button>
    </div>

    <section id="screenOnboarding" style="display:none">
      <div class="card" id="onbStep1" style="display:none">
        <p class="onbTitle">Wie heisst du?</p>
        <p class="onbSub">Nur fÃ¼r diese Gruppe.</p>
        <div class="field" style="margin-top:14px">
          <label>Name</label>
          <input id="onbName" type="text" placeholder="Dein Name" autocomplete="off" />
        </div>
        <button class="btn primary" id="btnOnbNext1">Weiter</button>
      </div>

      <div class="card" id="onbStep2" style="display:none">
        <p class="onbTitle">Was mÃ¶chtest du tun?</p>
        <p class="onbSub">Du kannst einen Raum erstellen oder mit Code beitreten.</p>
        <div class="row" style="margin-top:14px">
          <button class="btn primary" id="btnGoCreate">Raum erstellen</button>
          <button class="btn ghost" id="btnGoJoin">Beitreten</button>
        </div>
        <button class="btn ghost" id="btnOnbBack2" style="margin-top:10px">ZurÃ¼ck</button>
      </div>

      <div class="card" id="onbStepCreate" style="display:none">
        <p class="onbTitle">Raum erstellen</p>
        <p class="onbSub">Gib deiner Gruppe einen Namen.</p>
        <div class="field" style="margin-top:14px">
          <label>Gruppenname</label>
          <input id="onbRoomName" type="text" placeholder="Gruppenname" autocomplete="off" />
        </div>
        <button class="btn primary" id="btnCreate">Erstellen</button>
        <button class="btn ghost" id="btnOnbBackCreate" style="margin-top:10px">ZurÃ¼ck</button>
      </div>

      <div class="card" id="onbStepJoin" style="display:none">
        <p class="onbTitle">Beitreten</p>
        <p class="onbSub">Gib den Code deiner Gruppe ein.</p>
        <div class="field" style="margin-top:14px">
          <label>Code</label>
          <input id="onbJoinCode" type="text" placeholder="Code" autocomplete="off" />
        </div>
        <button class="btn primary" id="btnJoin">Beitreten</button>
        <button class="btn ghost" id="btnOnbBackJoin" style="margin-top:10px">ZurÃ¼ck</button>
      </div>
    </section>

    <section id="screenDash" style="display:none">
      <div class="card big">
        <div class="moodHeader">
          <div style="min-width:0">
            <h1 class="moodBigTitle" id="moodMainTitle">â€”</h1>
            <div class="moodBigSub" id="moodMainSub">â€”</div>
          </div>

          <button class="datePick" id="btnPickDate" title="Datum wÃ¤hlen">
            <span id="pickDateLabel">â€”</span>
            <span class="chev">â–¾</span>
          </button>
        </div>

        <div class="statsRow2">
          <div class="statBox">
            <div class="statLeft">
              <span class="statDot"></span>
              <div class="statText">
                <div class="statN" id="pillAvg">â€”</div>
                <div class="statL">durchschnitt</div>
              </div>
            </div>
          </div>
          <div class="statBox">
            <div class="statLeft">
              <span class="statDot" style="background:rgba(255,255,255,.55); box-shadow:0 0 0 4px rgba(255,255,255,.06)"></span>
              <div class="statText">
                <div class="statN" id="pillProgress">â€”</div>
                <div class="statL">check-ins</div>
              </div>
            </div>
          </div>
        </div>

        <div class="meter"><div id="meterFill"></div></div>

        <div class="recommend">
          <p class="big" id="recommendTitle">â€”</p>
          <p class="small" id="recommendDetail">â€”</p>
        </div>

        <div class="peopleGrid" id="peopleGrid"></div>
      </div>

      <div class="card">
        <div class="sectionHead">
          <div style="min-width:0">
            <p class="sectionTitle">Posts</p>
            <div class="smallText" id="postHint">â€”</div>
          </div>
          <button class="btn small ghost" id="btnNewPost">Post</button>
        </div>
        <div id="postList"></div>
      </div>
    </section>
  </div>

  <div class="checkinBar" id="checkinBar">
    <div class="inner">
      <div class="text">
        <p class="t1" id="checkinBarTitle">Check-in</p>
        <p class="t2" id="checkinBarSub">â€”</p>
      </div>
      <button class="primaryBtn" id="btnOpenCheckin">Check-in</button>
    </div>
  </div>

  <div class="modalBackdrop" id="modalCheckin" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="modalHead">
        <div>
          <h3 id="checkinTitle">Check-in</h3>
          <p id="checkinSubtitle">â€”</p>
        </div>
        <button class="xBtn" id="btnCloseCheckin" aria-label="Schliessen">âœ•</button>
      </div>

      <div class="sliderWrap">
        <div class="sliderTop">
          <div>
            <div style="font-size:12px; color:var(--muted)">Vibe (1â€“10)</div>
            <div class="sliderLabel" id="sliderLabel">â€”</div>
          </div>
          <div class="sliderVal" id="sliderVal">7</div>
        </div>

        <div class="rangeShell">
          <div class="rangeTrack"><div class="rangeFill" id="rangeFill"></div></div>
          <input type="range" min="1" max="10" step="1" value="7" id="rangeFit" />
        </div>
      </div>

      <div class="row" style="margin-top:12px">
        <button class="btn danger" id="btnCant">Nicht dabei</button>
        <button class="btn primary" id="btnSave">Speichern</button>
      </div>
    </div>
  </div>

  <div class="modalBackdrop" id="modalDate" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="modalHead">
        <div>
          <h3>Datum</h3>
          <p>3 Tage Â· wischen fÃ¼r die nÃ¤chsten</p>
        </div>
        <button class="xBtn" id="btnCloseDate" aria-label="Schliessen">âœ•</button>
      </div>

      <div class="pagerHead">
        <button class="navBtn" id="btnPagePrev" aria-label="ZurÃ¼ck">â€¹</button>
        <div class="pagerTitle" id="pageTitle">â€”</div>
        <button class="navBtn" id="btnPageNext" aria-label="Weiter">â€º</button>
      </div>

      <div class="dayStrip" id="dayStrip"></div>

      <div class="smallText" style="margin-top:10px">
        Punkte: grÃ¼n = Check-ins Â· Akzent = Posts
      </div>
    </div>
  </div>

  <div class="modalBackdrop" id="modalPost" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="modalHead">
        <div>
          <h3 id="postTitle">Neuer Post</h3>
          <p id="postSubtitle">â€”</p>
        </div>
        <button class="xBtn" id="btnClosePost" aria-label="Schliessen">âœ•</button>
      </div>

      <div class="field" style="margin-top:10px">
        <label>Text</label>
        <textarea id="inpPostText" placeholder="Text"></textarea>
      </div>

      <button class="btn primary" id="btnPost">Speichern</button>
    </div>
  </div>

  <div class="modalBackdrop" id="modalVote" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="modalHead">
        <div>
          <h3>Abstimmen</h3>
          <p id="voteSubtitle">â€”</p>
        </div>
        <button class="xBtn" id="btnCloseVote" aria-label="Schliessen">âœ•</button>
      </div>

      <div class="sliderWrap">
        <div class="sliderTop">
          <div>
            <div style="font-size:12px; color:var(--muted)">Skala (1â€“10)</div>
            <div class="sliderLabel">1 = gefÃ¤llt mir nicht Â· 10 = voll dabei</div>
          </div>
          <div class="sliderVal" id="voteVal">7</div>
        </div>

        <div class="rangeShell">
          <div class="rangeTrack"><div class="rangeFill" id="voteFill"></div></div>
          <input type="range" min="1" max="10" step="1" value="7" id="voteRange" />
        </div>
      </div>

      <button class="btn primary" id="btnSaveVote" style="margin-top:12px">Speichern</button>
    </div>
  </div>

  <div class="modalBackdrop" id="modalReply" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="modalHead">
        <div>
          <h3>Antwort</h3>
          <p id="replySubtitle">â€”</p>
        </div>
        <button class="xBtn" id="btnCloseReply" aria-label="Schliessen">âœ•</button>
      </div>

      <div class="field" style="margin-top:10px">
        <label>Text</label>
        <textarea id="inpReplyText" placeholder="Text"></textarea>
      </div>

      <button class="btn primary" id="btnSendReply">Senden</button>
    </div>
  </div>

  <div class="modalBackdrop" id="modalUser" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="modalHead">
        <div>
          <h3>Profil</h3>
          <p id="userSubtitle">â€”</p>
        </div>
        <button class="xBtn" id="btnCloseUser" aria-label="Schliessen">âœ•</button>
      </div>

      <div class="field">
        <label>Name</label>
        <input id="inpUserName" type="text" placeholder="Name" />
      </div>

      <div class="field">
        <label>Akzent</label>
        <select id="selAccent">
          <option value="#ff3b30">Rot</option>
          <option value="#007aff">Blau</option>
          <option value="#34c759">GrÃ¼n</option>
          <option value="#ff9500">Orange</option>
          <option value="#ffcc00">Gelb</option>
          <option value="#af52de">Violett</option>
          <option value="#00c7be">TÃ¼rkis</option>
          <option value="#ff2d55">Pink</option>
          <option value="#8e8e93">Grau</option>
        </select>
      </div>
    </div>
  </div>

  <div class="modalBackdrop" id="modalRoom" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="modalHead">
        <div>
          <h3 id="roomTitle">Raum</h3>
          <p id="roomSubtitle">â€”</p>
        </div>
        <button class="xBtn" id="btnCloseRoom" aria-label="Schliessen">âœ•</button>
      </div>

      <div class="linkRow">
        <div class="codeBox">
          <span style="font-size:12px; color:rgba(244,244,247,.70); font-weight:900">Code</span>
          <span class="code" id="roomCode">â€”</span>
        </div>
        <button class="btn ghost" id="btnCopyCode">Kopieren</button>
      </div>

      <div class="row" style="margin-top:12px">
        <button class="btn ghost" id="btnOpenWords">WÃ¶rter bearbeiten</button>
        <button class="btn danger" id="btnLeave">Raum verlassen</button>
      </div>
    </div>
  </div>

  <div class="modalBackdrop" id="modalWords" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="modalHead">
        <div>
          <h3>WÃ¶rter</h3>
          <p>3 auf einmal Â· wischen fÃ¼r die nÃ¤chsten</p>
        </div>
        <button class="xBtn" id="btnCloseWords" aria-label="Schliessen">âœ•</button>
      </div>

      <div class="pagerHead">
        <button class="navBtn" id="btnWordsPrev" aria-label="ZurÃ¼ck">â€¹</button>
        <div class="pagerTitle" id="wordsTitle">â€”</div>
        <button class="navBtn" id="btnWordsNext" aria-label="Weiter">â€º</button>
      </div>

      <div class="dayStrip" id="wordsStrip"></div>

      <button class="btn primary" id="btnSaveWords" style="margin-top:12px">Speichern</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import {
      getFirestore,
      doc, setDoc, getDoc, updateDoc, increment,
      collection, query, where, limit, getDocs, onSnapshot, orderBy,
      runTransaction, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBHSyx9ks_iUroCu2bnx231cpIDrY-p7sM",
      authDomain: "ometer-4cfd8.firebaseapp.com",
      projectId: "ometer-4cfd8",
      storageBucket: "ometer-4cfd8.firebasestorage.app",
      messagingSenderId: "42931867142",
      appId: "1:42931867142:web:7834e359d38949fe897d87",
      measurementId: "G-FZHWRWK717"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const $ = (s)=>document.querySelector(s);

    const loader = $("#loader");
    const loaderSub = $("#loaderSub");
    function showLoader(text="ladeâ€¦"){ loaderSub.textContent = text; loader.style.display="flex"; }
    function hideLoader(){ loader.style.display="none"; }

    const toastEl = $("#toast");
    const toastDot = $("#toastDot");
    const toastMsg = $("#toastMsg");
    $("#toastClose").onclick = ()=>toastEl.classList.remove("show");

    function toast(msg, kind="accent"){
      toastDot.className = "ppDot " + (kind==="good"?"good":kind==="warn"?"warn":kind==="bad"?"bad":"");
      toastMsg.textContent = msg;
      toastEl.classList.add("show");
      clearTimeout(toast._t);
      toast._t = setTimeout(()=>toastEl.classList.remove("show"), 3000);
    }
    function errText(e){
      if(!e) return "unknown";
      return e.code ? `${e.code}: ${e.message||String(e)}` : (e.message||String(e));
    }
    window.addEventListener("unhandledrejection", (e)=>{
      toast("Fehler: " + errText(e.reason), "bad");
      console.error(e.reason);
    });

    function openModal(el){ el.classList.add("show"); }
    function closeModal(el){ el.classList.remove("show"); }
    function bindBackdropClose(el){
      el.addEventListener("click", (e)=>{ if(e.target===el) closeModal(el); });
    }

    const modalCheckin = $("#modalCheckin");
    const modalDate = $("#modalDate");
    const modalPost = $("#modalPost");
    const modalVote = $("#modalVote");
    const modalReply = $("#modalReply");
    const modalUser = $("#modalUser");
    const modalRoom = $("#modalRoom");
    const modalWords = $("#modalWords");

    [modalCheckin, modalDate, modalPost, modalVote, modalReply, modalUser, modalRoom, modalWords].forEach(bindBackdropClose);

    const brandTitle = $("#brandTitle");
    const meLabel = $("#meLabel");
    const btnUser = $("#btnUser");

    const screenOnboarding = $("#screenOnboarding");
    const onbStep1 = $("#onbStep1");
    const onbStep2 = $("#onbStep2");
    const onbStepCreate = $("#onbStepCreate");
    const onbStepJoin = $("#onbStepJoin");

    const onbName = $("#onbName");
    const onbRoomName = $("#onbRoomName");
    const onbJoinCode = $("#onbJoinCode");

    const btnOnbNext1 = $("#btnOnbNext1");
    const btnGoCreate = $("#btnGoCreate");
    const btnGoJoin = $("#btnGoJoin");
    const btnOnbBack2 = $("#btnOnbBack2");
    const btnOnbBackCreate = $("#btnOnbBackCreate");
    const btnOnbBackJoin = $("#btnOnbBackJoin");

    const btnCreate = $("#btnCreate");
    const btnJoin = $("#btnJoin");

    const screenDash = $("#screenDash");
    const moodMainTitle = $("#moodMainTitle");
    const moodMainSub = $("#moodMainSub");
    const pickDateLabel = $("#pickDateLabel");
    const btnPickDate = $("#btnPickDate");

    const pillAvg = $("#pillAvg");
    const pillProgress = $("#pillProgress");

    const meterFill = $("#meterFill");
    const recommendTitle = $("#recommendTitle");
    const recommendDetail = $("#recommendDetail");
    const peopleGrid = $("#peopleGrid");

    const postHint = $("#postHint");
    const btnNewPost = $("#btnNewPost");
    const postList = $("#postList");

    const checkinBar = $("#checkinBar");
    const checkinBarTitle = $("#checkinBarTitle");
    const checkinBarSub = $("#checkinBarSub");
    const btnOpenCheckin = $("#btnOpenCheckin");

    const checkinTitle = $("#checkinTitle");
    const checkinSubtitle = $("#checkinSubtitle");
    const btnCloseCheckin = $("#btnCloseCheckin");
    const rangeFit = $("#rangeFit");
    const rangeFill = $("#rangeFill");
    const sliderVal = $("#sliderVal");
    const sliderLabel = $("#sliderLabel");
    const btnCant = $("#btnCant");
    const btnSave = $("#btnSave");

    const btnCloseDate = $("#btnCloseDate");
    const dayStrip = $("#dayStrip");
    const pageTitle = $("#pageTitle");
    const btnPagePrev = $("#btnPagePrev");
    const btnPageNext = $("#btnPageNext");

    const postTitle = $("#postTitle");
    const postSubtitle = $("#postSubtitle");
    const btnClosePost = $("#btnClosePost");
    const inpPostText = $("#inpPostText");
    const btnPost = $("#btnPost");

    const voteSubtitle = $("#voteSubtitle");
    const btnCloseVote = $("#btnCloseVote");
    const voteRange = $("#voteRange");
    const voteFill = $("#voteFill");
    const voteVal = $("#voteVal");
    const btnSaveVote = $("#btnSaveVote");

    const replySubtitle = $("#replySubtitle");
    const btnCloseReply = $("#btnCloseReply");
    const inpReplyText = $("#inpReplyText");
    const btnSendReply = $("#btnSendReply");

    const userSubtitle = $("#userSubtitle");
    const btnCloseUser = $("#btnCloseUser");
    const inpUserName = $("#inpUserName");
    const selAccent = $("#selAccent");

    const roomTitle = $("#roomTitle");
    const roomSubtitle = $("#roomSubtitle");
    const roomCode = $("#roomCode");
    const btnCloseRoom = $("#btnCloseRoom");
    const btnCopyCode = $("#btnCopyCode");
    const btnLeave = $("#btnLeave");
    const btnOpenWords = $("#btnOpenWords");

    const btnCloseWords = $("#btnCloseWords");
    const wordsStrip = $("#wordsStrip");
    const wordsTitle = $("#wordsTitle");
    const btnWordsPrev = $("#btnWordsPrev");
    const btnWordsNext = $("#btnWordsNext");
    const btnSaveWords = $("#btnSaveWords");

    const LS = "vibe_live_v4";
    const DEFAULT_LABELS = {
      1:"mega chill",
      2:"chillig",
      3:"easy",
      4:"ruhig",
      5:"normal",
      6:"gut drauf",
      7:"ready",
      8:"party",
      9:"steil",
      10:"loco"
    };

    function loadState(){
      try{
        const raw = localStorage.getItem(LS);
        if(!raw) throw 0;
        const s = JSON.parse(raw);
        return {
          name: s.name || "Gast",
          roomId: s.roomId || null,
          roomCode: s.roomCode || null,
          roomName: s.roomName || null,
          selectedDay: s.selectedDay || isoDate(),
          accent: s.accent || "#ff3b30",
          labels: s.labels || null
        };
      }catch(_){
        return { name:"Gast", roomId:null, roomCode:null, roomName:null, selectedDay: isoDate(), accent:"#ff3b30", labels:null };
      }
    }
    const state = loadState();
    function saveState(){ localStorage.setItem(LS, JSON.stringify(state)); }
    function applyAccent(hex){ document.documentElement.style.setProperty("--accent", hex); }
    applyAccent(state.accent);

    let currentUser = null;
    let roomDoc = null;
    let membersMap = {};
    let dayCheckins = {};
    let posts = [];
    let repliesByPost = new Map();

    const daySummary = {};
    let calDays = [];
    let page = 0;
    const PAGE_SIZE = 3;

    let wordsPage = 0;
    const WORDS_PAGE_SIZE = 3;

    let unsubRoom = null;
    let unsubDay = null;
    let unsubPosts = null;
    let unsubReplies = new Map();

    let replyingToPostId = null;
    let votingPostId = null;

    let editingPostId = null;

    function labelsMap(){
      const m = state.labels || roomDoc?.labels || null;
      if(!m) return DEFAULT_LABELS;
      const out = {};
      for(let i=1;i<=10;i++){
        const k = String(i);
        out[i] = (m[i] || m[k] || DEFAULT_LABELS[i] || "").trim() || DEFAULT_LABELS[i];
      }
      return out;
    }
    function fitLabel(n){
      const lm = labelsMap();
      return (lm[n] || "").trim() || "";
    }

    function pad2(n){ return String(n).padStart(2,"0"); }
    function isoDate(d=new Date()){
      return d.getFullYear()+"-"+pad2(d.getMonth()+1)+"-"+pad2(d.getDate());
    }
    function prettyDate(dayKey){
      const [y,m,dd] = dayKey.split("-").map(Number);
      const dt = new Date(y, m-1, dd);
      const wd = ["So","Mo","Di","Mi","Do","Fr","Sa"][dt.getDay()];
      return `${wd}, ${dd}.${m}.${y}`;
    }
    function shortDay(dayKey){
      const [y,m,dd] = dayKey.split("-").map(Number);
      const dt = new Date(y, m-1, dd);
      const wd = ["So","Mo","Di","Mi","Do","Fr","Sa"][dt.getDay()];
      return `${wd} ${dd}.${m}`;
    }
    function weekdayIndex(dayKey){
      const [y,m,dd]=dayKey.split("-").map(Number);
      return new Date(y,m-1,dd).getDay();
    }
    function clamp(n,a,b){ return Math.max(a, Math.min(b,n)); }
    function uid6(){ return Math.random().toString(36).slice(2, 8).toUpperCase(); }
    function uid12(){ return uid6()+uid6(); }

    function escapeHtml(str){
      return String(str).replace(/[&<>"']/g, s => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[s]));
    }

    function normalizeUrl(raw){
      const s = String(raw || "").trim();
      if(!s) return null;
      if(s.startsWith("http://") || s.startsWith("https://")) return s;
      if(s.startsWith("www.")) return "https://" + s;
      return null;
    }

    function hostLabel(url){
      try{
        const u = new URL(url);
        let h = u.hostname || url;
        if(h.startsWith("www.")) h = h.slice(4);
        return h;
      }catch(_){
        return url;
      }
    }

    function linkifyShort(text){
      const safe = escapeHtml(text);
      const re = /((https?:\/\/|www\.)[^\s<]+)/gi;
      return safe.replace(re, (m)=>{
        const href = m.startsWith("http") ? m : ("https://" + m);
        const label = hostLabel(href);
        return `<a href="${href}" target="_blank" rel="noopener noreferrer">${escapeHtml(label)}</a>`;
      });
    }

    function requireHttps(){
      if(location.protocol === "file:"){
        toast("Bitte Ã¼ber https Ã¶ffnen.", "bad");
        return false;
      }
      return true;
    }

    function showOnboarding(){
      screenOnboarding.style.display = "block";
      screenDash.style.display = "none";
      checkinBar.style.display = "none";
      setOnbStep(1);
      renderTop();
    }
    function showDash(){
      screenOnboarding.style.display = "none";
      screenDash.style.display = "block";
      checkinBar.style.display = "block";
      renderAll();
    }

    function setOnbStep(step){
      onbStep1.style.display = step===1 ? "block" : "none";
      onbStep2.style.display = step===2 ? "block" : "none";
      onbStepCreate.style.display = step===3 ? "block" : "none";
      onbStepJoin.style.display = step===4 ? "block" : "none";

      onbName.value = state.name==="Gast" ? "" : state.name;
      onbRoomName.value = state.roomName || "";
      onbJoinCode.value = "";
    }

    function renderTop(){
      meLabel.textContent = state.name;
      if(state.roomId){
        brandTitle.textContent = state.roomName || "Raum";
      }else{
        brandTitle.textContent = "Vibe";
      }
    }

    function myStatusText(){
      const c = dayCheckins[currentUser?.uid];
      if(!c) return "offen";
      if(c.status==="no") return "nicht dabei";
      if(c.status==="yes" && Number.isFinite(c.fitness)){
        return `${c.fitness} Â· ${fitLabel(c.fitness)}`;
      }
      return "â€”";
    }

    function computeMood(){
      const uids = Object.keys(membersMap);
      let answered=0, yesCount=0;
      const yes = [];

      for(const uid of uids){
        const c = dayCheckins[uid];
        if(!c) continue;
        answered++;
        if(c.status==="yes" && Number.isFinite(c.fitness)){
          yesCount++;
          yes.push({uid, name: c.name || membersMap[uid] || "â€”", fitness:c.fitness});
        }
      }

      const avg = yesCount ? yes.reduce((a,b)=>a+b.fitness,0)/yesCount : 0;
      let title = "â€”";
      let detail = "Warte auf Check-ins.";

      if(yesCount>0){
        const vibeScore = clamp(Math.round(avg),1,10);
        title = fitLabel(vibeScore);
        detail = `Ã˜ ${avg.toFixed(1)} Â· ${yesCount} dabei.`;
      }else{
        title = "noch offen";
        detail = `${answered}/${uids.length} check-ins.`;
      }

      return {uids, answered, yesCount, yes, avg, title, detail};
    }

    function dotClassForFitness(f){
      if(f>=8) return "good";
      if(f>=4 && f<=5) return "warn";
      if(f<=3) return "bad";
      return "";
    }

    function renderPeoplePills(mood){
      peopleGrid.innerHTML = "";
      const yesSorted = mood.yes.slice().sort((a,b)=>b.fitness-a.fitness);

      for(const it of yesSorted){
        const el = document.createElement("div");
        el.className = "personPill";
        const dc = dotClassForFitness(it.fitness);
        el.innerHTML = `
          <span class="ppMiniDot ${dc}"></span>
          <span class="ppName">${escapeHtml(it.name)}</span>
          <span class="ppVal">${it.fitness} Â· ${escapeHtml(fitLabel(it.fitness))}</span>
        `;
        peopleGrid.appendChild(el);
      }

      for(const [uid,name] of Object.entries(membersMap)){
        const c = dayCheckins[uid];
        if(c?.status==="no"){
          const el = document.createElement("div");
          el.className = "personPill ppMuted";
          el.innerHTML = `
            <span class="ppMiniDot bad"></span>
            <span class="ppName">${escapeHtml(name)}</span>
            <span class="ppVal">nicht dabei</span>
          `;
          peopleGrid.appendChild(el);
        }
      }

      for(const [uid,name] of Object.entries(membersMap)){
        if(!dayCheckins[uid]){
          const el = document.createElement("div");
          el.className = "personPill ppMuted";
          el.innerHTML = `
            <span class="ppMiniDot"></span>
            <span class="ppName">${escapeHtml(name)}</span>
            <span class="ppVal">offen</span>
          `;
          peopleGrid.appendChild(el);
        }
      }
    }

    function buildCalendar30(){
      const base = new Date();
      const days = [];
      for(let i=0;i<30;i++){
        const d = new Date(base);
        d.setDate(base.getDate()+i);
        days.push(isoDate(d));
      }
      return days;
    }

    async function refreshDaySummaries(){
      if(!state.roomId) return;
      calDays = buildCalendar30();

      await Promise.all(calDays.map(async (dayKey)=>{
        try{
          const ref = doc(db,"rooms",state.roomId,"days",dayKey);
          const snap = await getDoc(ref);
          if(!snap.exists()){
            daySummary[dayKey] = {checkins:0, posts:0};
            return;
          }
          const data = snap.data();
          daySummary[dayKey] = {
            checkins: Number(data.checkinCount || 0),
            posts: Number(data.postCount || 0)
          };
        }catch(_){
          daySummary[dayKey] = daySummary[dayKey] || {checkins:0, posts:0};
        }
      }));
    }

    function setPage(p){
      const maxPage = Math.ceil((calDays.length||30)/PAGE_SIZE)-1;
      page = clamp(p, 0, maxPage);
      renderDayStrip();
    }

    function renderDayStrip(){
      if(!calDays.length) calDays = buildCalendar30();
      const maxPage = Math.ceil(calDays.length/PAGE_SIZE)-1;
      page = clamp(page, 0, maxPage);

      const start = page*PAGE_SIZE;
      const slice = calDays.slice(start, start+PAGE_SIZE);
      const first = slice[0], last = slice[slice.length-1];
      pageTitle.textContent = `${shortDay(first)} â€“ ${shortDay(last)}`;

      dayStrip.innerHTML = "";
      for(const dayKey of slice){
        const sum = daySummary[dayKey] || {checkins:0, posts:0};
        const cell = document.createElement("div");
        cell.className = "dayCell" + (dayKey===state.selectedDay ? " active" : "");
        const wd = ["So","Mo","Di","Mi","Do","Fr","Sa"][weekdayIndex(dayKey)];
        const dnum = dayKey.slice(8,10);
        const mnum = dayKey.slice(5,7);

        cell.innerHTML = `
          <div class="dayTop">
            <span>${wd}</span>
            <span style="opacity:.8">${dnum}.${mnum}</span>
          </div>
          <div class="dayDots">
            <span class="miniDot ${sum.checkins>0 ? "check" : ""}"></span>
            <span class="miniDot ${sum.posts>0 ? "post" : ""}"></span>
          </div>
        `;

        cell.onclick = ()=>{
          setSelectedDay(dayKey);
          closeModal(modalDate);
        };

        dayStrip.appendChild(cell);
      }
    }

    function setSelectedDay(dayKey){
      state.selectedDay = dayKey;
      saveState();
      renderAll();
      if(state.roomId){
        attachDayListener(state.roomId, dayKey);
        attachPostsListener(state.roomId, dayKey);
      }
    }

    function avgRating(ratings){
      const vals = Object.values(ratings||{}).filter(v=>Number.isFinite(v) && v>0);
      if(!vals.length) return {avg:0, n:0};
      const sum = vals.reduce((a,b)=>a+Number(b),0);
      return {avg: sum/vals.length, n: vals.length};
    }

    function renderAll(){
      renderTop();

      pickDateLabel.textContent = shortDay(state.selectedDay);
      postHint.textContent = prettyDate(state.selectedDay);

      const mood = computeMood();

      moodMainTitle.textContent = mood.title;
      moodMainSub.textContent = myStatusText();

      pillAvg.textContent = mood.yesCount ? mood.avg.toFixed(1) : "â€”";
      pillProgress.textContent = mood.uids.length ? `${mood.answered}/${mood.uids.length}` : "â€”";

      const pct = (mood.answered / Math.max(1, mood.uids.length)) * 100;
      meterFill.style.width = `${Math.max(0, Math.min(100, pct))}%`;

      recommendTitle.textContent = mood.title;
      recommendDetail.textContent = mood.detail;

      renderPeoplePills(mood);

      const mine = dayCheckins[currentUser?.uid];
      checkinBarTitle.textContent = mine ? "Check-in bearbeiten" : "Check-in offen";
      checkinBarSub.textContent = mine ? `Aktuell: ${myStatusText()}` : "Tippe, um abzugeben.";

      setSliderUI(rangeFit.value);

      renderPosts();
    }

    function fmtTime(ms){
      const d = new Date(ms);
      return d.toLocaleTimeString("de-CH", {hour:"2-digit", minute:"2-digit"});
    }

    function renderPosts(){
      postList.innerHTML = "";

      const sorted = posts.slice().sort((a,b)=>{
        const ar = avgRating(a.ratings||{});
        const br = avgRating(b.ratings||{});
        const ad = ar.n ? ar.avg : 0;
        const bd = br.n ? br.avg : 0;
        if(bd !== ad) return bd - ad;
        return (b.createdAtMs||0) - (a.createdAtMs||0);
      });

      if(!sorted.length){
        const empty = document.createElement("div");
        empty.className="smallText";
        empty.style.marginTop="10px";
        empty.textContent="Noch keine Posts.";
        postList.appendChild(empty);
        return;
      }

      for(const p of sorted){
        const rat = avgRating(p.ratings||{});
        const myR = (p.ratings && p.ratings[currentUser?.uid]) ? p.ratings[currentUser?.uid] : 0;
        const repl = repliesByPost.get(p.id) || [];

        const el = document.createElement("div");
        el.className="post";

        const canEdit = (p.authorUid === currentUser?.uid);

        el.innerHTML = `
          <div class="postMeta">
            <div>${escapeHtml(p.authorName||"â€”")} Â· ${fmtTime(p.createdAtMs||Date.now())}</div>
            <div class="right">
              ${canEdit ? `<button class="iconBtn" style="height:34px; padding:0 12px; border-radius:14px" data-edit="1" data-id="${p.id}">Bearbeiten</button>` : ``}
            </div>
          </div>
          <div class="postText">${linkifyShort(p.text||"")}</div>

          <div class="voteRow">
            <div class="scoreChip">vibe ${rat.n ? rat.avg.toFixed(1) : "â€”"} Â· ${rat.n} stimmen</div>
            <button class="iconBtn" data-vote="1" data-id="${p.id}">
              Abstimmen${myR ? ` Â· ${myR}` : ``}
            </button>
            <button class="iconBtn" data-reply="1" data-id="${p.id}">
              Antworten
            </button>
          </div>

          <div class="replies" id="repl-${p.id}"></div>
        `;

        const btnVote = el.querySelector('.iconBtn[data-vote="1"]');
        btnVote.onclick = ()=>{
          votingPostId = p.id;
          const startVal = myR || 7;
          voteRange.value = String(startVal);
          setVoteUI(startVal);
          voteSubtitle.textContent = prettyDate(state.selectedDay);
          openModal(modalVote);
        };

        const btnReply = el.querySelector('.iconBtn[data-reply="1"]');
        btnReply.onclick = ()=>{
          replyingToPostId = p.id;
          inpReplyText.value="";
          replySubtitle.textContent = prettyDate(state.selectedDay);
          openModal(modalReply);
        };

        const btnEdit = el.querySelector('.iconBtn[data-edit="1"]');
        if(btnEdit){
          btnEdit.onclick = ()=>{
            editingPostId = p.id;
            postTitle.textContent = "Post bearbeiten";
            postSubtitle.textContent = prettyDate(state.selectedDay);
            inpPostText.value = p.text || "";
            btnPost.textContent = "Speichern";
            openModal(modalPost);
          };
        }

        const replWrap = el.querySelector(`#repl-${p.id}`);
        for(const r of repl){
          const re = document.createElement("div");
          re.className="reply";
          re.innerHTML = `
            <div class="replyMeta">${escapeHtml(r.authorName||"â€”")} Â· ${fmtTime(r.createdAtMs||Date.now())}</div>
            <div class="replyText">${linkifyShort(r.text||"")}</div>
          `;
          replWrap.appendChild(re);
        }

        postList.appendChild(el);
      }
    }

    async function detachAll(){
      if(unsubRoom){ try{unsubRoom();}catch{} unsubRoom=null; }
      if(unsubDay){ try{unsubDay();}catch{} unsubDay=null; }
      if(unsubPosts){ try{unsubPosts();}catch{} unsubPosts=null; }
      for(const fn of unsubReplies.values()){ try{ fn(); }catch{} }
      unsubReplies.clear();
      repliesByPost.clear();
    }

    async function attachRoomListener(roomId){
      if(unsubRoom){ try{unsubRoom();}catch{} unsubRoom=null; }
      unsubRoom = onSnapshot(doc(db,"rooms",roomId), (snap)=>{
        if(!snap.exists()){ toast("Raum nicht gefunden.", "bad"); return; }
        roomDoc = snap.data();
        membersMap = roomDoc.members || {};
        state.roomName = roomDoc.name || state.roomName;
        state.roomCode = roomDoc.code || state.roomCode;
        if(roomDoc.labels){
          state.labels = roomDoc.labels;
        }
        saveState();
        renderAll();
      });
    }

    async function attachDayListener(roomId, dayKey){
      if(unsubDay){ try{unsubDay();}catch{} unsubDay=null; }
      const ref = doc(db,"rooms",roomId,"days",dayKey);

      unsubDay = onSnapshot(ref, (snap)=>{
        if(!snap.exists()){
          dayCheckins = {};
          renderAll();
          return;
        }
        const data = snap.data();
        dayCheckins = data.checkins || {};
        renderAll();
      });
    }

    function attachPostsListener(roomId, dayKey){
      if(unsubPosts){ try{unsubPosts();}catch{} unsubPosts=null; }
      for(const fn of unsubReplies.values()){ try{ fn(); }catch{} }
      unsubReplies.clear();
      repliesByPost.clear();

      const col = collection(db,"rooms",roomId,"days",dayKey,"posts");
      const qy = query(col, orderBy("createdAtMs","desc"));

      unsubPosts = onSnapshot(qy, (qs)=>{
        posts = [];
        qs.forEach(d=>posts.push({ id:d.id, ...d.data() }));

        for(const p of posts){
          if(unsubReplies.has(p.id)) continue;
          const rcol = collection(db,"rooms",roomId,"days",dayKey,"posts",p.id,"replies");
          const rq = query(rcol, orderBy("createdAtMs","asc"));
          const unsub = onSnapshot(rq, (rqs)=>{
            const arr = [];
            rqs.forEach(rr=>arr.push({ id: rr.id, ...rr.data() }));
            repliesByPost.set(p.id, arr);
            renderPosts();
          });
          unsubReplies.set(p.id, unsub);
        }

        renderPosts();
      }, (err)=>{
        toast("Posts: " + errText(err), "bad");
      });
    }

    async function ensureMembership(roomId){
      const uid = currentUser.uid;
      const name = state.name || "Gast";
      await runTransaction(db, async (tx)=>{
        const ref = doc(db,"rooms",roomId);
        const snap = await tx.get(ref);
        if(!snap.exists()) throw new Error("Raum existiert nicht.");
        const data = snap.data();
        const members = data.members || {};
        if(members[uid] !== name){
          members[uid] = name;
          tx.update(ref, { members, updatedAt: serverTimestamp() });
        }
      });
    }

    async function createRoomOnline(){
      const roomId = uid12();
      const code = uid6();
      const name = (onbRoomName.value||"").trim().slice(0,32) || "Gruppe";
      const uid = currentUser.uid;
      const meName = state.name || "Gast";

      await setDoc(doc(db,"rooms",roomId), {
        name,
        code,
        labels: labelsMap(),
        members: { [uid]: meName },
        createdAt: serverTimestamp(),
        updatedAt: serverTimestamp()
      });

      state.roomId = roomId;
      state.roomCode = code;
      state.roomName = name;
      state.selectedDay = isoDate();
      state.labels = labelsMap();
      saveState();
    }

    async function joinRoomByCodeOnline(){
      const code = (onbJoinCode.value||"").trim().toUpperCase();
      if(!code) return null;

      const qy = query(collection(db,"rooms"), where("code","==", code), limit(1));
      const res = await getDocs(qy);
      if(res.empty) return null;

      const roomId = res.docs[0].id;
      const data = res.docs[0].data();

      state.roomId = roomId;
      state.roomCode = data.code || code;
      state.roomName = data.name || "Raum";
      state.selectedDay = isoDate();
      if(data.labels) state.labels = data.labels;
      saveState();

      await ensureMembership(roomId);
      return roomId;
    }

    async function setCheckin(payload){
      const roomId = state.roomId;
      const dayKey = state.selectedDay;
      const dayRef = doc(db,"rooms",roomId,"days",dayKey);
      const uid = currentUser.uid;

      await runTransaction(db, async (tx)=>{
        const snap = await tx.get(dayRef);
        const data = snap.exists() ? snap.data() : {};
        const checkins = data.checkins || {};
        checkins[uid] = payload;

        tx.set(dayRef, {
          checkins,
          updatedAt: serverTimestamp(),
          checkinCount: Object.keys(checkins).length,
          postCount: Number(data.postCount || 0)
        }, { merge:true });
      });

      await refreshDaySummaries();
      renderDayStrip();
    }

    async function addPost(){
      const text = (inpPostText.value||"").trim();
      if(!text) return;

      const roomId = state.roomId;
      const dayKey = state.selectedDay;
      const postId = uid12();

      const postRef = doc(db,"rooms",roomId,"days",dayKey,"posts",postId);
      const dayRef  = doc(db,"rooms",roomId,"days",dayKey);

      await setDoc(postRef, {
        text,
        authorUid: currentUser.uid,
        authorName: state.name || "Gast",
        createdAtMs: Date.now(),
        ratings: {},
        updatedAt: serverTimestamp()
      }, { merge:true });

      await setDoc(dayRef, {
        postCount: increment(1),
        updatedAt: serverTimestamp()
      }, { merge:true });

      await refreshDaySummaries();
      renderDayStrip();
    }

    async function editPost(postId, newText){
      const roomId = state.roomId;
      const dayKey = state.selectedDay;
      const ref = doc(db,"rooms",roomId,"days",dayKey,"posts",postId);

      await runTransaction(db, async (tx)=>{
        const snap = await tx.get(ref);
        if(!snap.exists()) return;
        const data = snap.data();
        if(data.authorUid !== currentUser.uid) return;
        tx.update(ref, { text: newText, updatedAt: serverTimestamp() });
      });
    }

    async function setRating(postId, val){
      const roomId = state.roomId;
      const dayKey = state.selectedDay;
      const ref = doc(db,"rooms",roomId,"days",dayKey,"posts",postId);

      await runTransaction(db, async (tx)=>{
        const snap = await tx.get(ref);
        if(!snap.exists()) return;
        const data = snap.data();
        const ratings = data.ratings || {};
        ratings[currentUser.uid] = val;
        tx.update(ref, { ratings, updatedAt: serverTimestamp() });
      });
    }

    async function sendReply(){
      const text = (inpReplyText.value||"").trim();
      if(!text || !replyingToPostId) return;

      const roomId = state.roomId;
      const dayKey = state.selectedDay;
      const replyId = uid12();

      await setDoc(doc(db,"rooms",roomId,"days",dayKey,"posts",replyingToPostId,"replies",replyId), {
        text,
        authorUid: currentUser.uid,
        authorName: state.name || "Gast",
        createdAtMs: Date.now()
      });

      replyingToPostId = null;
    }

    function setSliderUI(v){
      const val = Number(v);
      sliderVal.textContent = String(val);
      sliderLabel.textContent = fitLabel(val);
      const pct = ((val - 1) / 9) * 100;
      rangeFill.style.width = `${pct}%`;
    }

    function setVoteUI(v){
      const val = Number(v);
      voteVal.textContent = String(val);
      const pct = ((val - 1) / 9) * 100;
      voteFill.style.width = `${pct}%`;
    }

    async function registerSW(){
      if(!("serviceWorker" in navigator)) return;
      try{ await navigator.serviceWorker.register("./sw.js"); }catch(e){}
    }

    async function withBusy(btn, fn){
      const prev = btn.textContent;
      btn.disabled = true;
      btn.textContent = "â€¦";
      try{ return await fn(); }
      finally{ btn.disabled = false; btn.textContent = prev; }
    }

    function openRoomModal(){
      if(!state.roomId) return;
      roomTitle.textContent = state.roomName || "Raum";
      roomSubtitle.textContent = " ";
      roomCode.textContent = state.roomCode || "â€”";
      openModal(modalRoom);
    }

    function openWordsModal(){
      wordsPage = 0;
      renderWordsStrip();
      openModal(modalWords);
    }

    function renderWordsStrip(){
      const start = wordsPage * WORDS_PAGE_SIZE;
      const end = Math.min(10, start + WORDS_PAGE_SIZE);
      wordsTitle.textContent = `${start+1}â€“${end} / 10`;

      const lm = labelsMap();

      wordsStrip.innerHTML = "";
      for(let i=start+1;i<=end;i++){
        const cell = document.createElement("div");
        cell.className = "dayCell";
        cell.innerHTML = `
          <div class="dayTop">
            <span>${i}</span>
            <span style="opacity:.8"></span>
          </div>
          <div style="margin-top:10px">
            <input type="text" data-k="${i}" value="${escapeHtml(lm[i]||"")}" placeholder="Wort" style="width:100%; height:44px; border-radius:14px; border:1px solid rgba(255,255,255,.10); background:rgba(255,255,255,.03); color:var(--text); padding:10px 12px; outline:none; text-transform: lowercase" />
          </div>
          <div class="dayDots">
            <span class="miniDot post"></span>
          </div>
        `;
        wordsStrip.appendChild(cell);
      }
    }

    function setWordsPage(p){
      const maxPage = Math.ceil(10/WORDS_PAGE_SIZE)-1;
      wordsPage = clamp(p, 0, maxPage);
      renderWordsStrip();
    }

    function collectWordsFromModal(){
      const lm = labelsMap();
      const inputs = wordsStrip.querySelectorAll("input[data-k]");
      inputs.forEach(inp=>{
        const k = Number(inp.dataset.k);
        const v = (inp.value||"").trim().slice(0,24) || DEFAULT_LABELS[k];
        lm[k] = v.toLowerCase();
      });
      return lm;
    }

    (function initSwipeMain(){
      const root = $("#swipeRoot");
      let sx=null, sy=null, moved=false;
      root.addEventListener("touchstart", (e)=>{
        const t=e.touches[0]; sx=t.clientX; sy=t.clientY; moved=false;
      }, {passive:true});
      root.addEventListener("touchmove", (e)=>{
        if(sx==null) return;
        const t=e.touches[0];
        if(Math.abs(t.clientX-sx)>10 || Math.abs(t.clientY-sy)>10) moved=true;
      }, {passive:true});
      root.addEventListener("touchend", (e)=>{
        if(sx==null) return;
        const t=e.changedTouches[0];
        const dx=t.clientX-sx, dy=t.clientY-sy;
        sx=sy=null;
        if(!moved) return;
        if(Math.abs(dx)<70 || Math.abs(dx)<Math.abs(dy)) return;

        if(!calDays.length) calDays = buildCalendar30();
        const i = calDays.indexOf(state.selectedDay);
        if(i<0) return;
        if(dx<0 && i<calDays.length-1) setSelectedDay(calDays[i+1]);
        if(dx>0 && i>0) setSelectedDay(calDays[i-1]);
      }, {passive:true});
    })();

    (function initSwipePager(){
      let sx=null, sy=null, moved=false;
      dayStrip.addEventListener("touchstart", (e)=>{
        const t=e.touches[0]; sx=t.clientX; sy=t.clientY; moved=false;
      }, {passive:true});
      dayStrip.addEventListener("touchmove", (e)=>{
        if(sx==null) return;
        const t=e.touches[0];
        if(Math.abs(t.clientX-sx)>10 || Math.abs(t.clientY-sy)>10) moved=true;
      }, {passive:true});
      dayStrip.addEventListener("touchend", (e)=>{
        if(sx==null) return;
        const t=e.changedTouches[0];
        const dx=t.clientX-sx, dy=t.clientY-sy;
        sx=sy=null;
        if(!moved) return;
        if(Math.abs(dx)<60 || Math.abs(dx)<Math.abs(dy)) return;
        if(dx<0) setPage(page+1);
        if(dx>0) setPage(page-1);
      }, {passive:true});
    })();

    (function initSwipeWords(){
      let sx=null, sy=null, moved=false;
      wordsStrip.addEventListener("touchstart", (e)=>{
        const t=e.touches[0]; sx=t.clientX; sy=t.clientY; moved=false;
      }, {passive:true});
      wordsStrip.addEventListener("touchmove", (e)=>{
        if(sx==null) return;
        const t=e.touches[0];
        if(Math.abs(t.clientX-sx)>10 || Math.abs(t.clientY-sy)>10) moved=true;
      }, {passive:true});
      wordsStrip.addEventListener("touchend", (e)=>{
        if(sx==null) return;
        const t=e.changedTouches[0];
        const dx=t.clientX-sx, dy=t.clientY-sy;
        sx=sy=null;
        if(!moved) return;
        if(Math.abs(dx)<60 || Math.abs(dx)<Math.abs(dy)) return;
        if(dx<0) setWordsPage(wordsPage+1);
        if(dx>0) setWordsPage(wordsPage-1);
      }, {passive:true});
    })();

    brandTitle.onclick = ()=>{
      if(state.roomId) openRoomModal();
    };

    btnUser.onclick = ()=>{
      inpUserName.value = state.name || "Gast";
      selAccent.value = state.accent || "#ff3b30";
      userSubtitle.textContent = state.roomId ? (state.roomName || " ") : " ";
      openModal(modalUser);
    };
    btnCloseUser.onclick = ()=>closeModal(modalUser);

    inpUserName.addEventListener("change", async ()=>{
      const n = (inpUserName.value||"").trim().slice(0,24) || "Gast";
      state.name = n;
      saveState();
      meLabel.textContent = n;
      onbName.value = n;
      toast("Gespeichert", "good");
      if(state.roomId && currentUser){
        try{ await ensureMembership(state.roomId); }catch(e){ toast(errText(e),"warn"); }
      }
    });
    selAccent.addEventListener("change", ()=>{
      state.accent = selAccent.value;
      saveState();
      applyAccent(state.accent);
      toast("Akzent gesetzt", "good");
    });

    btnCloseRoom.onclick = ()=>closeModal(modalRoom);
    btnCopyCode.onclick = async ()=>{
      if(!state.roomCode) return;
      try{
        await navigator.clipboard.writeText(state.roomCode);
        toast("Kopiert", "good");
      }catch(_){
        toast("Konnte nicht kopieren", "warn");
      }
    };
    btnOpenWords.onclick = ()=>{
      closeModal(modalRoom);
      openWordsModal();
    };
    btnLeave.onclick = async ()=>{
      if(!confirm("Raum verlassen?")) return;
      await detachAll();
      state.roomId=null; state.roomCode=null; state.roomName=null;
      saveState();
      closeModal(modalRoom);
      showOnboarding();
    };

    btnCloseWords.onclick = ()=>closeModal(modalWords);
    btnWordsPrev.onclick = ()=>setWordsPage(wordsPage-1);
    btnWordsNext.onclick = ()=>setWordsPage(wordsPage+1);
    btnSaveWords.onclick = async ()=>{
      if(!state.roomId) return;
      const merged = collectWordsFromModal();
      try{
        await updateDoc(doc(db,"rooms",state.roomId), { labels: merged, updatedAt: serverTimestamp() });
        state.labels = merged;
        saveState();
        closeModal(modalWords);
        renderAll();
        toast("Gespeichert", "good");
      }catch(e){
        toast(errText(e), "bad");
      }
    };

    btnPickDate.onclick = async ()=>{
      await refreshDaySummaries();
      if(!calDays.length) calDays = buildCalendar30();
      const idx = calDays.indexOf(state.selectedDay);
      page = idx>=0 ? Math.floor(idx/PAGE_SIZE) : 0;
      renderDayStrip();
      openModal(modalDate);
    };
    btnCloseDate.onclick = ()=>closeModal(modalDate);
    btnPagePrev.onclick = ()=>setPage(page-1);
    btnPageNext.onclick = ()=>setPage(page+1);

    btnOpenCheckin.onclick = ()=>{
      checkinTitle.textContent = `Check-in`;
      checkinSubtitle.textContent = state.roomName || " ";
      const existing = dayCheckins[currentUser?.uid];
      const val = (existing?.status==="yes" && Number.isFinite(existing.fitness)) ? existing.fitness : 7;
      rangeFit.value = String(val);
      setSliderUI(val);
      openModal(modalCheckin);
    };
    btnCloseCheckin.onclick = ()=>closeModal(modalCheckin);
    rangeFit.oninput = ()=>setSliderUI(rangeFit.value);

    btnSave.onclick = async ()=>{
      try{
        await setCheckin({ status:"yes", fitness:Number(rangeFit.value), atMs:Date.now(), name: state.name });
        closeModal(modalCheckin);
        toast("Gespeichert", "good");
      }catch(e){
        toast(errText(e), "bad");
      }
    };
    btnCant.onclick = async ()=>{
      try{
        await setCheckin({ status:"no", atMs:Date.now(), name: state.name });
        closeModal(modalCheckin);
        toast("Gespeichert", "good");
      }catch(e){
        toast(errText(e), "bad");
      }
    };

    btnNewPost.onclick = ()=>{
      editingPostId = null;
      postTitle.textContent = "Neuer Post";
      postSubtitle.textContent = prettyDate(state.selectedDay);
      inpPostText.value="";
      btnPost.textContent = "Posten";
      openModal(modalPost);
    };
    btnClosePost.onclick = ()=>closeModal(modalPost);
    btnPost.onclick = async ()=>{
      const t = (inpPostText.value||"").trim();
      if(!t){ toast("Bitte Text", "warn"); return; }
      try{
        if(editingPostId){
          await editPost(editingPostId, t);
          editingPostId = null;
          closeModal(modalPost);
          toast("Gespeichert", "good");
        }else{
          await addPost();
          closeModal(modalPost);
          toast("Gepostet", "good");
        }
      }catch(e){
        toast(errText(e), "bad");
      }
    };

    btnCloseVote.onclick = ()=>closeModal(modalVote);
    voteRange.oninput = ()=>setVoteUI(voteRange.value);
    btnSaveVote.onclick = async ()=>{
      if(!votingPostId) return;
      try{
        await setRating(votingPostId, Number(voteRange.value));
        votingPostId = null;
        closeModal(modalVote);
        toast("Gespeichert", "good");
      }catch(e){
        toast(errText(e), "bad");
      }
    };

    btnCloseReply.onclick = ()=>closeModal(modalReply);
    btnSendReply.onclick = async ()=>{
      const t = (inpReplyText.value||"").trim();
      if(!t){ toast("Bitte Text", "warn"); return; }
      try{
        await sendReply();
        closeModal(modalReply);
        toast("Gesendet", "good");
      }catch(e){
        toast(errText(e), "bad");
      }
    };

    btnOnbNext1.onclick = ()=>{
      const n = (onbName.value||"").trim().slice(0,24) || "Gast";
      state.name = n;
      saveState();
      renderTop();
      setOnbStep(2);
    };
    btnOnbBack2.onclick = ()=>setOnbStep(1);
    btnGoCreate.onclick = ()=>setOnbStep(3);
    btnGoJoin.onclick = ()=>setOnbStep(4);
    btnOnbBackCreate.onclick = ()=>setOnbStep(2);
    btnOnbBackJoin.onclick = ()=>setOnbStep(2);

    async function attachAllForRoom(){
      await detachAll();
      await ensureMembership(state.roomId);
      await attachRoomListener(state.roomId);
      await attachDayListener(state.roomId, state.selectedDay);
      attachPostsListener(state.roomId, state.selectedDay);
      await refreshDaySummaries();
      renderDayStrip();
    }

    btnCreate.addEventListener("click", async ()=>{
      if(!requireHttps()) return;
      if(!currentUser){ toast("Auth noch nicht bereitâ€¦", "warn"); return; }
      state.name = (onbName.value||"").trim().slice(0,24) || "Gast";
      saveState();

      await withBusy(btnCreate, async ()=>{
        showLoader("Erstelleâ€¦");
        await createRoomOnline();
        await attachAllForRoom();
        hideLoader();
        showDash();
        toast(`Code: ${state.roomCode}`, "good");
      });
    });

    btnJoin.addEventListener("click", async ()=>{
      if(!requireHttps()) return;
      if(!currentUser){ toast("Auth noch nicht bereitâ€¦", "warn"); return; }
      state.name = (onbName.value||"").trim().slice(0,24) || "Gast";
      saveState();

      await withBusy(btnJoin, async ()=>{
        showLoader("Trete beiâ€¦");
        const roomId = await joinRoomByCodeOnline();
        if(!roomId){ hideLoader(); toast("Code nicht gefunden", "bad"); return; }
        await attachAllForRoom();
        hideLoader();
        showDash();
        toast("Beigetreten", "good");
      });
    });

    (async function boot(){
      if(!requireHttps()){
        hideLoader();
        showOnboarding();
        return;
      }

      calDays = buildCalendar30();
      setSliderUI(rangeFit.value);
      setVoteUI(voteRange.value);
      showLoader("verbindeâ€¦");
      await registerSW();

      onAuthStateChanged(auth, async (u)=>{
        currentUser = u;

        if(!u){
          try{ await signInAnonymously(auth); return; }
          catch(e){
            hideLoader();
            toast("Firebase Auth fehlt.", "bad");
            showOnboarding();
            return;
          }
        }

        try{
          renderTop();
          if(state.roomId){
            showLoader("Lade Raumâ€¦");
            await attachAllForRoom();
            hideLoader();
            showDash();
          }else{
            hideLoader();
            showOnboarding();
          }
        }catch(e){
          hideLoader();
          toast(errText(e), "bad");
          state.roomId=null; state.roomCode=null; state.roomName=null;
          saveState();
          showOnboarding();
        }
      });
    })();
  </script>
</body>
</html>