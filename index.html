<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#0b0b0f" />
  <title>FitCheck</title>

  <style>
    :root{
      --bg:#0b0b0f;
      --panel: rgba(255,255,255,.04);
      --line: rgba(255,255,255,.08);
      --text:#f4f4f7;
      --muted:#a8a8b3;
      --accent:#7c5cff; /* <- changes via settings */
      --good:#3ddc97;
      --warn:#ffd166;
      --bad:#ff5c7a;

      --r:18px;
      --r2:24px;

      --safeTop: env(safe-area-inset-top);
      --safeBottom: env(safe-area-inset-bottom);
      --safeLeft: env(safe-area-inset-left);
      --safeRight: env(safe-area-inset-right);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:
        radial-gradient(900px 560px at 18% -12%, color-mix(in srgb, var(--accent) 18%, transparent), transparent 58%),
        radial-gradient(800px 520px at 110% 14%, color-mix(in srgb, var(--accent) 12%, transparent), transparent 60%),
        var(--bg);
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, "SF Pro Display", "SF Pro Text", Segoe UI, Roboto, Helvetica, Arial;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      overscroll-behavior: none;
    }

    button,input,select,textarea{font:inherit}
    a{color:inherit}

    .app{
      min-height:100%;
      padding:
        calc(14px + var(--safeTop))
        calc(14px + var(--safeRight))
        calc(92px + var(--safeBottom))
        calc(14px + var(--safeLeft));
      max-width: 520px;
      margin: 0 auto;
    }

    /* Topbar */
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom: 10px;
    }
    .brand{display:flex; align-items:center; gap:10px; min-width:0}
    .logo{
      width:34px;height:34px;border-radius:12px;
      background: linear-gradient(180deg, color-mix(in srgb, var(--accent) 92%, #000), color-mix(in srgb, var(--accent) 48%, #000));
      box-shadow: 0 14px 32px color-mix(in srgb, var(--accent) 18%, transparent);
      position:relative;
      flex:0 0 auto;
    }
    .logo:after{
      content:"";
      position:absolute; inset:10px;
      border-radius:10px;
      border: 1px solid rgba(255,255,255,.22);
      background: rgba(0,0,0,.10);
    }
    .brandTitle{
      font-size: 14px;
      font-weight: 900;
      letter-spacing:.2px;
      margin:0;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .brandSub{
      margin-top:3px;
      font-size: 12px;
      color: var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .pill{
      height: 34px;
      padding: 0 12px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.02);
      display:flex;
      align-items:center;
      gap:8px;
      color: var(--text);
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      transition: transform .08s ease, background .2s ease, border-color .2s ease;
      white-space:nowrap;
      flex:0 0 auto;
    }
    .pill:active{transform: scale(.98)}
    .pill:hover{background: rgba(255,255,255,.04); border-color: rgba(255,255,255,.12)}

    /* Cards */
    .card{
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: var(--r2);
      padding: 14px;
      margin: 10px 0;
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      box-shadow: 0 18px 60px rgba(0,0,0,.45);
    }
    .divider{height:1px; background: var(--line); margin: 12px 0}

    /* Inputs */
    .field{display:flex; flex-direction:column; gap:8px; margin: 10px 0}
    label{font-size:12px; color:var(--muted)}
    input[type="text"], input[type="time"], select, textarea{
      border-radius: 16px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.03);
      color: var(--text);
      padding: 12px 14px;
      outline:none;
    }
    input[type="text"], input[type="time"], select{height: 50px}
    textarea{min-height: 92px; resize: vertical}
    input::placeholder, textarea::placeholder{color: rgba(168,168,179,.7)}

    .btn{
      height: 50px;
      border-radius: 16px;
      border: 1px solid color-mix(in srgb, var(--accent) 34%, transparent);
      background: color-mix(in srgb, var(--accent) 16%, transparent);
      color: var(--text);
      padding: 0 14px;
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      transition: transform .08s ease, background .2s ease, border-color .2s ease;
      display:flex; align-items:center; justify-content:center;
      gap:10px;
    }
    .btn:active{transform: scale(.98)}
    .btn:hover{background: color-mix(in srgb, var(--accent) 20%, transparent)}
    .btn.secondary{
      border-color: var(--line);
      background: rgba(255,255,255,.02);
    }
    .btn.secondary:hover{background: rgba(255,255,255,.04)}
    .btn.danger{
      border-color: color-mix(in srgb, var(--bad) 34%, transparent);
      background: color-mix(in srgb, var(--bad) 14%, transparent);
    }
    .btn.danger:hover{background: color-mix(in srgb, var(--bad) 18%, transparent)}
    .btn.small{height: 42px; border-radius: 14px; font-size: 13px}
    .btn.full{width:100%}

    /* Minimal day picker (30 days) */
    .calWrap{display:flex; align-items:center; justify-content:space-between; gap:10px}
    .calStrip{
      display:flex;
      gap:8px;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
      scrollbar-width:none;
      padding-bottom: 2px;
      flex:1;
    }
    .calStrip::-webkit-scrollbar{display:none}
    .dDot{
      flex:0 0 auto;
      width: 44px;
      padding: 10px 0;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.02);
      text-align:center;
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .dDot .n{font-size: 13px; font-weight: 900}
    .dDot .w{font-size: 11px; color: var(--muted); margin-top:2px}
    .dDot.active{
      border-color: color-mix(in srgb, var(--accent) 45%, transparent);
      background: color-mix(in srgb, var(--accent) 14%, transparent);
    }

    /* KPIs */
    .kpi{display:flex; gap:10px}
    .kpi .box{
      flex:1;
      border: 1px solid rgba(255,255,255,.08);
      border-radius: 16px;
      padding: 10px 12px;
      background: rgba(0,0,0,.18);
      min-width: 0;
    }
    .kpi .num{margin:0; font-size: 18px; font-weight: 950}
    .kpi .lbl{margin: 4px 0 0; font-size: 12px; color: var(--muted)}
    .meter{
      margin-top: 10px;
      border: 1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.03);
      border-radius: 999px;
      height: 10px;
      overflow:hidden;
    }
    .meter > div{
      height:100%;
      width: 0%;
      background: linear-gradient(90deg, color-mix(in srgb, var(--accent) 90%, #000), color-mix(in srgb, var(--accent) 55%, #000));
      border-radius: 999px;
      transition: width .35s ease;
    }
    .recommend{
      margin-top: 12px;
      padding: 12px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
    }
    .recommend .big{margin:0; font-size: 15px; font-weight: 950; letter-spacing:.2px}
    .recommend .small{margin: 6px 0 0; font-size: 12px; color: rgba(244,244,247,.82); line-height:1.35}

    /* Status chips */
    .chips{display:flex; flex-wrap:wrap; gap:8px; margin-top: 10px}
    .chip{
      border: 1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.02);
      padding: 8px 10px;
      border-radius: 999px;
      font-size: 12px;
      display:flex; align-items:center; gap:8px;
    }
    .dot{
      width:8px; height:8px; border-radius: 50%;
      background: var(--accent);
      box-shadow: 0 0 0 3px color-mix(in srgb, var(--accent) 12%, transparent);
      flex:0 0 auto;
    }
    .dot.good{background: var(--good); box-shadow: 0 0 0 3px rgba(61,220,151,.10)}
    .dot.warn{background: var(--warn); box-shadow: 0 0 0 3px rgba(255,209,102,.10)}
    .dot.bad{background: var(--bad); box-shadow: 0 0 0 3px rgba(255,92,122,.10)}

    /* Check-in bar */
    .checkinBar{
      position: fixed;
      left: 50%;
      bottom: calc(10px + var(--safeBottom));
      transform: translateX(-50%);
      width: min(520px, calc(100% - 20px));
      border-radius: 22px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(17,17,26,.74);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      box-shadow: 0 18px 60px rgba(0,0,0,.55);
      padding: 8px;
      z-index: 40;
    }
    .checkinBar .inner{display:flex; align-items:center; gap:10px}
    .checkinBar .text{min-width:0; flex:1}
    .checkinBar .t1{
      margin:0;
      font-size: 13px;
      font-weight: 950;
      letter-spacing:.2px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .checkinBar .t2{
      margin:2px 0 0;
      font-size: 12px;
      color: var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .primaryBtn{
      height: 46px;
      border-radius: 16px;
      border: 1px solid color-mix(in srgb, var(--accent) 40%, transparent);
      background: color-mix(in srgb, var(--accent) 18%, transparent);
      padding: 0 14px;
      color: var(--text);
      cursor:pointer;
      display:flex;
      align-items:center;
      gap:8px;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      flex:0 0 auto;
    }

    /* Modals */
    .modalBackdrop{
      position: fixed; inset:0;
      background: rgba(0,0,0,.58);
      display:none;
      align-items:flex-end;
      padding: 14px;
      padding-bottom: calc(14px + var(--safeBottom));
      z-index: 50;
    }
    .modalBackdrop.show{display:flex}
    .modal{
      width: min(520px, 100%);
      margin: 0 auto;
      background: rgba(17,17,26,.92);
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 26px;
      padding: 14px;
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
      box-shadow: 0 24px 80px rgba(0,0,0,.65);
    }
    .modalHead{
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
      margin-bottom: 10px;
    }
    .modalHead h3{margin:0; font-size: 14px}
    .modalHead p{margin: 6px 0 0; font-size: 12px; color: var(--muted); line-height:1.35}
    .sliderWrap{
      margin-top: 10px;
      padding: 12px;
      border-radius: var(--r);
      border: 1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.02);
    }
    .sliderTop{display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom: 10px}
    .sliderVal{
      font-size: 18px;
      font-weight: 950;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      min-width: 52px;
      text-align:center;
    }
    input[type="range"]{width:100%; accent-color: var(--accent)}

    /* Posts (day only) + replies */
    .post{
      border: 1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.02);
      border-radius: 18px;
      padding: 12px;
      margin-top: 10px;
    }
    .postMeta{font-size: 12px; color: var(--muted)}
    .postText{margin-top:8px; font-size:13px; line-height:1.35; white-space:pre-wrap; word-break:break-word}
    .voteRow{margin-top:10px; display:flex; align-items:center; gap:8px; flex-wrap:wrap}
    .voteBtn{
      height: 40px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.12);
      color: var(--text);
      padding: 0 12px;
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .voteBtn.active{
      border-color: color-mix(in srgb, var(--accent) 45%, transparent);
      background: color-mix(in srgb, var(--accent) 14%, transparent);
    }
    .smallText{font-size:12px; color:var(--muted)}
    .replies{margin-top:10px; display:flex; flex-direction:column; gap:8px}
    .reply{
      border: 1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.12);
      border-radius: 14px;
      padding: 10px;
    }
    .replyMeta{font-size:12px; color:var(--muted)}
    .replyText{margin-top:6px; font-size:13px; line-height:1.35; white-space:pre-wrap; word-break:break-word}

    /* Toast */
    .toast{
      position: fixed;
      top: calc(12px + var(--safeTop));
      left: 50%;
      transform: translateX(-50%);
      width: min(520px, calc(100% - 20px));
      z-index: 60;
      display:none;
    }
    .toast.show{display:block}
    .toast .inner{
      background: rgba(17,17,26,.90);
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 18px;
      padding: 12px 14px;
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      box-shadow: 0 18px 50px rgba(0,0,0,.55);
      display:flex; gap:10px; align-items:flex-start;
    }
    .toast .msg{font-size: 13px; line-height: 1.35}
    .toast .x{
      margin-left:auto;
      border:0;
      background: transparent;
      color: rgba(244,244,247,.75);
      cursor:pointer;
      height: 28px; width: 28px;
      border-radius: 10px;
    }
    .toast .x:hover{background: rgba(255,255,255,.06)}
  </style>
</head>

<body>
  <div class="toast" id="toast">
    <div class="inner">
      <span class="dot" id="toastDot"></span>
      <div class="msg" id="toastMsg"></div>
      <button class="x" id="toastClose" aria-label="Schliessen">✕</button>
    </div>
  </div>

  <div class="app" id="swipeRoot">
    <div class="topbar">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div style="min-width:0">
          <div class="brandTitle" id="brandTitle">FitCheck</div>
          <div class="brandSub" id="brandSub">online · Firebase</div>
        </div>
      </div>
      <button class="pill" id="btnMe" title="Menu">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M12 12a4.5 4.5 0 1 0-4.5-4.5A4.5 4.5 0 0 0 12 12Zm0 2c-4.42 0-8 2.24-8 5v1h16v-1c0-2.76-3.58-5-8-5Z" fill="currentColor" opacity=".9"/>
        </svg>
        <span id="meLabel">Gast</span>
      </button>
    </div>

    <!-- WELCOME -->
    <section id="screenWelcome">
      <div class="card">
        <div class="field">
          <label>Dein Name</label>
          <input id="inpName" type="text" placeholder="z.B. Noa" autocomplete="off" />
        </div>

        <div class="divider"></div>

        <div class="field">
          <label>Raum erstellen</label>
          <input id="inpRoomName" type="text" placeholder="z.B. Larries" autocomplete="off" />
        </div>
        <button class="btn full" id="btnCreate">Raum erstellen</button>

        <div class="divider"></div>

        <div class="field">
          <label>Mit Code beitreten</label>
          <input id="inpJoinCode" type="text" placeholder="z.B. D7OIX6" autocomplete="off" />
        </div>
        <button class="btn secondary full" id="btnJoin">Beitreten</button>

        <div class="smallText" style="margin-top:10px; line-height:1.45">
          Mitglieder werden nicht beim Erstellen gesetzt — alle treten per Code bei.
        </div>
      </div>
    </section>

    <!-- DASH -->
    <section id="screenDash" style="display:none">
      <div class="card">
        <div class="calWrap">
          <div class="calStrip" id="calStrip"></div>
        </div>
        <div class="smallText" style="margin-top:8px; display:flex; justify-content:space-between; gap:10px">
          <span id="selectedDateLabel">—</span>
          <span>Swipe ↔</span>
        </div>
      </div>

      <div class="card">
        <div style="font-size:13px; font-weight:950" id="dashTitle">—</div>
        <div class="smallText" id="dashSub" style="margin-top:4px">—</div>

        <div class="divider"></div>

        <div class="kpi">
          <div class="box"><p class="num" id="kpiAnswered">0</p><p class="lbl">abgegeben</p></div>
          <div class="box"><p class="num" id="kpiNope">0</p><p class="lbl">abgesagt</p></div>
          <div class="box"><p class="num" id="kpiPending">0</p><p class="lbl">offen</p></div>
        </div>

        <div class="meter"><div id="meterFill"></div></div>

        <div class="recommend">
          <p class="big" id="recommendTitle">—</p>
          <p class="small" id="recommendDetail">—</p>
        </div>

        <div class="chips" id="chipsList"></div>
      </div>

      <div class="card">
        <div style="display:flex; align-items:center; justify-content:space-between; gap:10px">
          <div style="min-width:0">
            <div style="font-size:13px; font-weight:950">Posts (nur dieser Tag)</div>
            <div class="smallText" id="postHint" style="margin-top:4px">—</div>
          </div>
          <button class="btn small secondary" id="btnNewPost">Post</button>
        </div>
        <div id="postList"></div>
      </div>
    </section>
  </div>

  <!-- Check-in bar (always available; becomes “edit” when already set) -->
  <div class="checkinBar" id="checkinBar" style="display:none">
    <div class="inner">
      <div class="text">
        <p class="t1" id="checkinBarTitle">Check-in</p>
        <p class="t2" id="checkinBarSub">—</p>
      </div>
      <button class="primaryBtn" id="btnOpenCheckin">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
        Check-in
      </button>
    </div>
  </div>

  <!-- Check-in modal -->
  <div class="modalBackdrop" id="modalCheckin" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="modalHead">
        <div>
          <h3 id="checkinTitle">Check-in</h3>
          <p id="checkinSubtitle">—</p>
        </div>
        <button class="pill" id="btnCloseCheckin" style="height:34px; padding:0 10px">Schliessen</button>
      </div>

      <div class="sliderWrap">
        <div class="sliderTop">
          <div style="font-size:12px; color:var(--muted)">Fit-Score (1–10)</div>
          <div class="sliderVal" id="sliderVal">7</div>
        </div>
        <input type="range" min="1" max="10" step="1" value="7" id="rangeFit" />
        <div style="display:flex; justify-content:space-between; margin-top:8px; color:var(--muted); font-size:11px">
          <span>1</span><span>10</span>
        </div>
      </div>

      <div style="display:flex; gap:10px; margin-top:12px">
        <button class="btn danger full" id="btnCant">Kann nicht</button>
        <button class="btn full" id="btnSave">Speichern</button>
      </div>
    </div>
  </div>

  <!-- New post modal -->
  <div class="modalBackdrop" id="modalPost" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="modalHead">
        <div>
          <h3>Neuer Post</h3>
          <p id="postSubtitle">—</p>
        </div>
        <button class="pill" id="btnClosePost" style="height:34px; padding:0 10px">Schliessen</button>
      </div>

      <div class="field" style="margin-top:10px">
        <label>Text</label>
        <textarea id="inpPostText" placeholder="z.B. Konzert in 2 Wochen Freitag – wer wäre ume?"></textarea>
      </div>

      <button class="btn full" id="btnPost">Posten</button>
    </div>
  </div>

  <!-- Reply modal -->
  <div class="modalBackdrop" id="modalReply" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="modalHead">
        <div>
          <h3>Antwort</h3>
          <p id="replySubtitle">—</p>
        </div>
        <button class="pill" id="btnCloseReply" style="height:34px; padding:0 10px">Schliessen</button>
      </div>

      <div class="field" style="margin-top:10px">
        <label>Text</label>
        <textarea id="inpReplyText" placeholder="z.B. Ich wär dabei."></textarea>
      </div>

      <button class="btn full" id="btnSendReply">Senden</button>
    </div>
  </div>

  <!-- Menu modal (simpler) -->
  <div class="modalBackdrop" id="modalMenu" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="modalHead">
        <div>
          <h3>Menu</h3>
          <p id="menuSubtitle">—</p>
        </div>
        <button class="pill" id="btnCloseMenu" style="height:34px; padding:0 10px">Schliessen</button>
      </div>

      <div class="field">
        <label>Name</label>
        <input id="inpMenuName" type="text" placeholder="Dein Name" />
      </div>

      <div class="field">
        <label>Akzent</label>
        <select id="selAccent">
          <option value="#7c5cff">Violett</option>
          <option value="#00d1ff">Cyan</option>
          <option value="#3ddc97">Mint</option>
          <option value="#ff5c7a">Pink</option>
          <option value="#ffd166">Gold</option>
        </select>
      </div>

      <div style="display:flex; gap:10px">
        <button class="btn secondary full" id="btnCopyCode" style="display:none">Code kopieren</button>
        <button class="btn danger full" id="btnLeave" style="display:none">Raum verlassen</button>
      </div>

      <div class="divider"></div>

      <div class="smallText" style="line-height:1.45">
        Push-Notifications (Web Push) – “richtige” Benachrichtigungen<br>
        • Service Worker + Push-Subscription nötig.<br>
        • Server/Cloud Function muss Push auslösen.<br>
        • iOS/Safari: am zuverlässigsten als installierte PWA (Homescreen) + Erlaubnis.
      </div>
    </div>
  </div>

  <script type="module">
    /***********************************************************************
     * Firebase (online, Firestore)
     * IMPORTANT: Firestore rules must allow read/write, or add Auth.
     ***********************************************************************/
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getFirestore, doc, setDoc, getDoc, updateDoc, serverTimestamp,
             collection, onSnapshot, query, where, limit, getDocs, orderBy } from
      "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBHSyx9ks_iUroCu2bnx231cpIDrY-p7sM",
      authDomain: "ometer-4cfd8.firebaseapp.com",
      projectId: "ometer-4cfd8",
      storageBucket: "ometer-4cfd8.firebasestorage.app",
      messagingSenderId: "42931867142",
      appId: "1:42931867142:web:7834e359d38949fe897d87",
      measurementId: "G-FZHWRWK717"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    /***********************************************************************
     * Data model (Firestore)
     * rooms/{roomId} => { name, code, members:[], createdAt, updatedAt }
     * rooms/{roomId}/days/{YYYY-MM-DD} => { checkins:{Name:{status,fitness,atMs}}, updatedAt }
     * rooms/{roomId}/days/{YYYY-MM-DD}/posts/{postId} => { text, author, createdAtMs, votes:{Name:-1|0|1}, votersUp:[Name], votersDown:[Name], replies:[{id,author,text,createdAtMs}], updatedAt }
     ***********************************************************************/

    /***********************************************************************
     * Local state (minimal)
     ***********************************************************************/
    const LS = "fitcheck_state_live_v1";
    const state = loadState();
    applyAccent(state.accent);

    let unsubRoom = null;
    let unsubDay = null;
    let unsubPosts = null;

    // UI
    const $ = (s)=>document.querySelector(s);
    const screenWelcome = $("#screenWelcome");
    const screenDash = $("#screenDash");
    const brandTitle = $("#brandTitle");
    const brandSub = $("#brandSub");
    const meLabel = $("#meLabel");

    const inpName = $("#inpName");
    const inpRoomName = $("#inpRoomName");
    const inpJoinCode = $("#inpJoinCode");
    const btnCreate = $("#btnCreate");
    const btnJoin = $("#btnJoin");

    const calStrip = $("#calStrip");
    const selectedDateLabel = $("#selectedDateLabel");

    const dashTitle = $("#dashTitle");
    const dashSub = $("#dashSub");

    const kpiAnswered = $("#kpiAnswered");
    const kpiNope = $("#kpiNope");
    const kpiPending = $("#kpiPending");
    const meterFill = $("#meterFill");

    const recommendTitle = $("#recommendTitle");
    const recommendDetail = $("#recommendDetail");
    const chipsList = $("#chipsList");

    const postHint = $("#postHint");
    const btnNewPost = $("#btnNewPost");
    const postList = $("#postList");

    const checkinBar = $("#checkinBar");
    const checkinBarTitle = $("#checkinBarTitle");
    const checkinBarSub = $("#checkinBarSub");
    const btnOpenCheckin = $("#btnOpenCheckin");

    const modalCheckin = $("#modalCheckin");
    const checkinTitle = $("#checkinTitle");
    const checkinSubtitle = $("#checkinSubtitle");
    const btnCloseCheckin = $("#btnCloseCheckin");
    const rangeFit = $("#rangeFit");
    const sliderVal = $("#sliderVal");
    const btnCant = $("#btnCant");
    const btnSave = $("#btnSave");

    const modalPost = $("#modalPost");
    const postSubtitle = $("#postSubtitle");
    const btnClosePost = $("#btnClosePost");
    const inpPostText = $("#inpPostText");
    const btnPost = $("#btnPost");

    const modalReply = $("#modalReply");
    const replySubtitle = $("#replySubtitle");
    const btnCloseReply = $("#btnCloseReply");
    const inpReplyText = $("#inpReplyText");
    const btnSendReply = $("#btnSendReply");
    let replyingToPostId = null;

    const modalMenu = $("#modalMenu");
    const btnMe = $("#btnMe");
    const btnCloseMenu = $("#btnCloseMenu");
    const menuSubtitle = $("#menuSubtitle");
    const inpMenuName = $("#inpMenuName");
    const selAccent = $("#selAccent");
    const btnCopyCode = $("#btnCopyCode");
    const btnLeave = $("#btnLeave");

    // Toast
    const toastEl = $("#toast");
    const toastDot = $("#toastDot");
    const toastMsg = $("#toastMsg");
    $("#toastClose").onclick = ()=>toastEl.classList.remove("show");

    function toast(msg, kind="accent"){
      toastDot.className = "dot " + (kind==="good"?"good":kind==="warn"?"warn":kind==="bad"?"bad":"");
      toastMsg.textContent = msg;
      toastEl.classList.add("show");
      clearTimeout(toast._t);
      toast._t = setTimeout(()=>toastEl.classList.remove("show"), 2200);
    }

    // Helpers
    function pad2(n){ return String(n).padStart(2,"0"); }
    function isoDate(d=new Date()){
      return d.getFullYear()+"-"+pad2(d.getMonth()+1)+"-"+pad2(d.getDate());
    }
    function weekdayIndex(d=new Date()){ return (d.getDay()+6)%7; } // Mo..So
    function shortW(dayKey){
      const [y,m,d] = dayKey.split("-").map(Number);
      const dt = new Date(y, m-1, d);
      return ["So","Mo","Di","Mi","Do","Fr","Sa"][dt.getDay()];
    }
    function prettyDate(dayKey){
      const [y,m,d] = dayKey.split("-").map(Number);
      const dt = new Date(y, m-1, d);
      const wd = ["So","Mo","Di","Mi","Do","Fr","Sa"][dt.getDay()];
      return `${wd}, ${d}.${m}.${y}`;
    }
    function uid(){
      return Math.random().toString(36).slice(2, 8).toUpperCase();
    }
    function escapeHtml(str){
      return String(str).replace(/[&<>"']/g, s => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[s]));
    }

    function applyAccent(hex){
      document.documentElement.style.setProperty("--accent", hex);
    }

    function loadState(){
      const raw = localStorage.getItem(LS);
      if(raw){
        try{
          const s = JSON.parse(raw);
          return {
            name: s.name || "Gast",
            roomId: s.roomId || null,
            roomCode: s.roomCode || null,
            roomName: s.roomName || null,
            selectedDay: s.selectedDay || isoDate(),
            accent: s.accent || "#7c5cff"
          };
        }catch(e){}
      }
      return { name:"Gast", roomId:null, roomCode:null, roomName:null, selectedDay: isoDate(), accent:"#7c5cff" };
    }
    function saveState(){
      localStorage.setItem(LS, JSON.stringify(state));
    }

    function openModal(el){ el.classList.add("show"); }
    function closeModal(el){ el.classList.remove("show"); }
    function bindBackdropClose(el){
      el.addEventListener("click", (e)=>{ if(e.target===el) closeModal(el); });
    }
    bindBackdropClose(modalCheckin);
    bindBackdropClose(modalPost);
    bindBackdropClose(modalReply);
    bindBackdropClose(modalMenu);

    /***********************************************************************
     * Calendar (30 days)
     ***********************************************************************/
    function buildCalendar30(){
      const base = new Date();
      const days = [];
      for(let i=0;i<30;i++){
        const d = new Date(base);
        d.setDate(base.getDate()+i);
        days.push(isoDate(d));
      }
      return days;
    }

    function setSelectedDay(dayKey, {scroll=true}={}){
      state.selectedDay = dayKey;
      saveState();
      renderCalendar();
      if(state.roomId){
        attachDayListener(state.roomId, dayKey);
        attachPostsListener(state.roomId, dayKey);
      }
      if(scroll){
        const el = calStrip.querySelector(`[data-day="${dayKey}"]`);
        if(el) el.scrollIntoView({behavior:"smooth", inline:"center", block:"nearest"});
      }
      renderHeaderLine();
    }

    function renderCalendar(){
      const cal = buildCalendar30();
      calStrip.innerHTML = "";
      for(const dayKey of cal){
        const el = document.createElement("div");
        el.className = "dDot" + (dayKey===state.selectedDay ? " active" : "");
        el.dataset.day = dayKey;
        el.innerHTML = `<div class="n">${dayKey.slice(8,10)}</div><div class="w">${shortW(dayKey)}</div>`;
        el.onclick = ()=>setSelectedDay(dayKey);
        calStrip.appendChild(el);
      }
      selectedDateLabel.textContent = prettyDate(state.selectedDay);
    }

    // Swipe between days (simple)
    (function initSwipe(){
      const root = $("#swipeRoot");
      let sx=null, sy=null, moved=false;
      root.addEventListener("touchstart", (e)=>{
        const t = e.touches[0];
        sx=t.clientX; sy=t.clientY; moved=false;
      }, {passive:true});
      root.addEventListener("touchmove", (e)=>{
        if(sx==null) return;
        const t = e.touches[0];
        const dx=t.clientX-sx, dy=t.clientY-sy;
        if(Math.abs(dx)>10 || Math.abs(dy)>10) moved=true;
      }, {passive:true});
      root.addEventListener("touchend", (e)=>{
        if(sx==null) return;
        const t = e.changedTouches[0];
        const dx=t.clientX-sx, dy=t.clientY-sy;
        sx=sy=null;
        if(!moved) return;
        if(Math.abs(dx)<55 || Math.abs(dx)<Math.abs(dy)) return;

        const cal = buildCalendar30();
        const i = cal.indexOf(state.selectedDay);
        if(i<0) return;
        if(dx<0 && i<cal.length-1) setSelectedDay(cal[i+1]);
        if(dx>0 && i>0) setSelectedDay(cal[i-1]);
      }, {passive:true});
    })();

    /***********************************************************************
     * Firestore helpers
     ***********************************************************************/
    async function detachAll(){
      if(unsubRoom){ try{unsubRoom();}catch(e){} unsubRoom=null; }
      if(unsubDay){ try{unsubDay();}catch(e){} unsubDay=null; }
      if(unsubPosts){ try{unsubPosts();}catch(e){} unsubPosts=null; }
    }

    async function attachRoomListener(roomId){
      if(unsubRoom){ try{unsubRoom();}catch(e){} unsubRoom=null; }
      const roomRef = doc(db, "rooms", roomId);
      unsubRoom = onSnapshot(roomRef, (snap)=>{
        if(!snap.exists()) return;
        const data = snap.data();
        state.roomName = data.name || state.roomName;
        state.roomCode = data.code || state.roomCode;
        saveState();
        renderTop();
        renderMenu();
      });
    }

    async function attachDayListener(roomId, dayKey){
      if(unsubDay){ try{unsubDay();}catch(e){} unsubDay=null; }
      const dayRef = doc(db, "rooms", roomId, "days", dayKey);
      unsubDay = onSnapshot(dayRef, (snap)=>{
        const data = snap.exists() ? snap.data() : { checkins:{} };
        window.__dayCheckins = data.checkins || {};
        renderDay();
      });
    }

    async function attachPostsListener(roomId, dayKey){
      if(unsubPosts){ try{unsubPosts();}catch(e){} unsubPosts=null; }
      const postsCol = collection(db, "rooms", roomId, "days", dayKey, "posts");
      const qy = query(postsCol, orderBy("createdAtMs","desc"));
      unsubPosts = onSnapshot(qy, (qs)=>{
        const posts = [];
        qs.forEach(docSnap=>{
          posts.push({ id: docSnap.id, ...docSnap.data() });
        });
        window.__posts = posts;
        renderPosts();
      });
    }

    /***********************************************************************
     * Room create/join
     ***********************************************************************/
    async function createRoomOnline(roomName){
      const roomId = uid()+uid();
      const code = uid(); // simple 6 chars
      const name = (roomName||"").trim().slice(0,32) || "Neuer Raum";

      const roomRef = doc(db, "rooms", roomId);
      await setDoc(roomRef, {
        name,
        code,
        members: [state.name],
        createdAt: serverTimestamp(),
        updatedAt: serverTimestamp()
      });

      state.roomId = roomId;
      state.roomCode = code;
      state.roomName = name;
      state.selectedDay = isoDate();
      saveState();

      await attachRoomListener(roomId);
      await attachDayListener(roomId, state.selectedDay);
      await attachPostsListener(roomId, state.selectedDay);

      toast(`Code: ${code}`, "good");
      showDash();
    }

    async function joinRoomByCodeOnline(codeRaw){
      const code = (codeRaw||"").trim().toUpperCase();
      if(!code) throw new Error("code missing");

      // find room by code
      const roomsCol = collection(db, "rooms");
      const qy = query(roomsCol, where("code","==", code), limit(1));
      const res = await getDocs(qy);
      if(res.empty) return null;

      const roomDoc = res.docs[0];
      const roomId = roomDoc.id;
      const roomData = roomDoc.data();

      // add member (naive merge)
      const members = Array.isArray(roomData.members) ? roomData.members : [];
      if(!members.includes(state.name)) members.push(state.name);

      const roomRef = doc(db, "rooms", roomId);
      await updateDoc(roomRef, { members, updatedAt: serverTimestamp() });

      state.roomId = roomId;
      state.roomCode = roomData.code || code;
      state.roomName = roomData.name || "Raum";
      state.selectedDay = isoDate();
      saveState();

      await attachRoomListener(roomId);
      await attachDayListener(roomId, state.selectedDay);
      await attachPostsListener(roomId, state.selectedDay);

      return { roomId };
    }

    /***********************************************************************
     * Check-ins
     ***********************************************************************/
    function myStatusText(dayCheckins){
      const c = dayCheckins[state.name];
      if(!c) return "offen";
      if(c.status==="no") return "kann nicht";
      if(c.status==="yes") return String(c.fitness ?? "—");
      return "—";
    }

    function computeRecommendation(members, dayCheckins){
      let answered=0, noCount=0;
      const yes=[];
      for(const name of members){
        const c = dayCheckins[name];
        if(!c) continue;
        answered++;
        if(c.status==="no") noCount++;
        if(c.status==="yes" && Number.isFinite(c.fitness)) yes.push({name, fitness:c.fitness});
      }
      const pending = Math.max(0, members.length - answered);
      const sliderUsers = yes.length;
      const avg = sliderUsers ? yes.reduce((a,b)=>a+b.fitness,0)/sliderUsers : 0;
      const eightPlus = sliderUsers ? yes.filter(x=>x.fitness>=8).length : 0;
      const pct8 = sliderUsers ? eightPlus/sliderUsers : 0;

      let title="Noch zu wenig Daten", detail="Warte auf Check-ins.";
      if(sliderUsers>0){
        if(pct8>=0.5 && sliderUsers>=2){ title="Party-Zeit"; detail=`${Math.round(pct8*100)}% haben 8+ (Ø ${avg.toFixed(1)}).`; }
        else if(avg>=6){ title="Etwas unternehmen"; detail=`Ø ${avg.toFixed(1)}.`; }
        else if(avg>=4){ title="Etwas Ruhiges"; detail=`Ø ${avg.toFixed(1)}.`; }
        else{ title="Ganz ruhig"; detail=`Ø ${avg.toFixed(1)}.`; }
      }
      return {answered,noCount,pending,yes,title,detail};
    }

    async function setCheckin(dayKey, payload){
      const dayRef = doc(db, "rooms", state.roomId, "days", dayKey);
      // merge-style write (read current snapshot cache + setDoc)
      const dayCheckins = window.__dayCheckins || {};
      const next = { ...dayCheckins, [state.name]: payload };
      await setDoc(dayRef, { checkins: next, updatedAt: serverTimestamp() }, { merge:true });
    }

    /***********************************************************************
     * Posts (day only), votes (show who), replies (stored in array)
     ***********************************************************************/
    function scoreFromVotes(votes){
      return Object.values(votes||{}).reduce((a,b)=>a+(Number(b)||0),0);
    }
    function votersList(votes, val){
      return Object.entries(votes||{}).filter(([,v])=>v===val).map(([k])=>k);
    }

    async function addPost(dayKey, text){
      const t = (text||"").trim();
      if(!t) return;

      const postId = uid()+uid();
      const postRef = doc(db, "rooms", state.roomId, "days", dayKey, "posts", postId);
      await setDoc(postRef, {
        text: t,
        author: state.name,
        createdAtMs: Date.now(),
        votes: {},
        replies: [],
        updatedAt: serverTimestamp()
      }, { merge:true });
    }

    async function toggleVote(dayKey, postId, voteVal){
      const postRef = doc(db, "rooms", state.roomId, "days", dayKey, "posts", postId);
      const snap = await getDoc(postRef);
      if(!snap.exists()) return;
      const data = snap.data();
      const votes = data.votes || {};
      const prev = votes[state.name] || 0;
      votes[state.name] = (prev===voteVal) ? 0 : voteVal;
      await updateDoc(postRef, { votes, updatedAt: serverTimestamp() });
    }

    async function addReply(dayKey, postId, text){
      const t = (text||"").trim();
      if(!t) return;

      const postRef = doc(db, "rooms", state.roomId, "days", dayKey, "posts", postId);
      const snap = await getDoc(postRef);
      if(!snap.exists()) return;
      const data = snap.data();
      const replies = Array.isArray(data.replies) ? data.replies : [];
      replies.push({ id: uid()+uid(), author: state.name, text: t, createdAtMs: Date.now() });
      await updateDoc(postRef, { replies, updatedAt: serverTimestamp() });
    }

    /***********************************************************************
     * Render
     ***********************************************************************/
    function showDash(){
      screenWelcome.style.display = "none";
      screenDash.style.display = "block";
      checkinBar.style.display = "block";
      renderTop();
      renderCalendar();
      renderHeaderLine();
      renderMenu();
      // listeners will call renderDay/renderPosts
    }

    function showWelcome(){
      screenWelcome.style.display = "block";
      screenDash.style.display = "none";
      checkinBar.style.display = "none";
      renderTop();
      renderMenu();
    }

    function renderTop(){
      meLabel.textContent = state.name;
      inpName.value = state.name==="Gast" ? "" : state.name;

      if(state.roomId){
        brandTitle.textContent = state.roomName || "Raum";
        brandSub.textContent = `Code: ${state.roomCode || "—"}`;
      }else{
        brandTitle.textContent = "FitCheck";
        brandSub.textContent = "online · Firebase";
      }
    }

    function renderHeaderLine(){
      if(!state.roomId) return;
      dashTitle.textContent = prettyDate(state.selectedDay);
      dashSub.textContent = `Dein Check-in: ${myStatusText(window.__dayCheckins||{})}`;
      postHint.textContent = `${prettyDate(state.selectedDay)}`;
    }

    function renderDay(){
      if(!state.roomId) return;

      const dayCheckins = window.__dayCheckins || {};
      const roomMembers = window.__roomMembers || []; // filled via room listener below
      const rec = computeRecommendation(roomMembers, dayCheckins);

      kpiAnswered.textContent = rec.answered;
      kpiNope.textContent = rec.noCount;
      kpiPending.textContent = rec.pending;

      const pct = (rec.answered / Math.max(1, roomMembers.length)) * 100;
      meterFill.style.width = `${Math.max(0, Math.min(100, pct))}%`;

      recommendTitle.textContent = rec.title;
      recommendDetail.textContent = rec.detail;

      chipsList.innerHTML = "";
      const yesSorted = [...rec.yes].sort((a,b)=>b.fitness-a.fitness);
      for(const {name,fitness} of yesSorted){
        const dotClass = fitness>=8 ? "good" : fitness>=6 ? "" : fitness>=4 ? "warn" : "bad";
        chipsList.appendChild(chip(`${name} · ${fitness}`, dotClass));
      }
      for(const name of roomMembers){
        const c = dayCheckins[name];
        if(c?.status==="no") chipsList.appendChild(chip(`${name} · kann nicht`, "bad"));
      }
      for(const name of roomMembers){
        if(!dayCheckins[name]) chipsList.appendChild(chip(`${name} · offen`, ""));
      }

      // checkin bar text
      const mine = dayCheckins[state.name];
      checkinBarTitle.textContent = mine ? "Check-in bearbeiten" : "Check-in offen";
      checkinBarSub.textContent = mine ? `Aktuell: ${myStatusText(dayCheckins)}` : "Tippe, um abzugeben.";
      renderHeaderLine();
    }

    function chip(text, dotClass=""){
      const el = document.createElement("div");
      el.className = "chip";
      el.innerHTML = `<span class="dot ${dotClass}"></span><span>${escapeHtml(text)}</span>`;
      return el;
    }

    function renderPosts(){
      const posts = window.__posts || [];
      postList.innerHTML = "";

      if(posts.length===0){
        const empty = document.createElement("div");
        empty.className = "smallText";
        empty.style.marginTop = "10px";
        empty.textContent = "Noch keine Posts.";
        postList.appendChild(empty);
        return;
      }

      for(const p of posts){
        const votes = p.votes || {};
        const score = scoreFromVotes(votes);
        const up = votersList(votes, 1);
        const down = votersList(votes, -1);
        const myVote = votes[state.name] || 0;

        const el = document.createElement("div");
        el.className = "post";
        el.innerHTML = `
          <div class="postMeta">${escapeHtml(p.author||"—")} · ${new Date(p.createdAtMs||Date.now()).toLocaleString("de-CH")}</div>
          <div class="postText">${escapeHtml(p.text||"")}</div>
          <div class="voteRow">
            <button class="voteBtn ${myVote===1?"active":""}" data-v="1" data-id="${p.id}">▲ Up</button>
            <button class="voteBtn ${myVote===-1?"active":""}" data-v="-1" data-id="${p.id}">▼ Down</button>
            <span class="smallText">Score: ${score}</span>
            <button class="voteBtn" data-reply="1" data-id="${p.id}">Antworten</button>
          </div>
          <div class="smallText" style="margin-top:8px">
            Up: ${up.length? escapeHtml(up.join(", ")) : "—"}<br>
            Down: ${down.length? escapeHtml(down.join(", ")) : "—"}
          </div>
          <div class="replies" id="repl-${p.id}"></div>
        `;

        // bind votes
        el.querySelectorAll(".voteBtn[data-v]").forEach(b=>{
          b.onclick = async ()=>{
            await toggleVote(state.selectedDay, p.id, Number(b.dataset.v));
          };
        });

        // bind reply
        const rb = el.querySelector('.voteBtn[data-reply="1"]');
        rb.onclick = ()=>{
          replyingToPostId = p.id;
          inpReplyText.value = "";
          replySubtitle.textContent = `${prettyDate(state.selectedDay)} · Post von ${p.author||"—"}`;
          openModal(modalReply);
        };

        // render replies
        const replWrap = el.querySelector(`#repl-${p.id}`);
        const replies = Array.isArray(p.replies) ? p.replies : [];
        if(replies.length){
          for(const r of replies.slice().sort((a,b)=>(a.createdAtMs||0)-(b.createdAtMs||0))){
            const re = document.createElement("div");
            re.className = "reply";
            re.innerHTML = `
              <div class="replyMeta">${escapeHtml(r.author||"—")} · ${new Date(r.createdAtMs||Date.now()).toLocaleString("de-CH")}</div>
              <div class="replyText">${escapeHtml(r.text||"")}</div>
            `;
            replWrap.appendChild(re);
          }
        }

        postList.appendChild(el);
      }
    }

    function renderMenu(){
      inpMenuName.value = state.name;
      selAccent.value = state.accent || "#7c5cff";
      menuSubtitle.textContent = state.roomId ? `${state.roomName || "Raum"} · ${state.roomCode || "—"}` : "—";

      btnCopyCode.style.display = state.roomId ? "block" : "none";
      btnLeave.style.display = state.roomId ? "block" : "none";
    }

    /***********************************************************************
     * Menu / settings actions
     ***********************************************************************/
    btnMe.onclick = ()=>{ renderMenu(); openModal(modalMenu); };
    btnCloseMenu.onclick = ()=>closeModal(modalMenu);

    inpMenuName.addEventListener("change", async ()=>{
      const n = (inpMenuName.value||"").trim().slice(0,24) || "Gast";
      state.name = n;
      saveState();
      meLabel.textContent = n;
      toast("Name gespeichert", "good");

      // if in a room: ensure membership contains name (naive)
      if(state.roomId){
        const roomRef = doc(db, "rooms", state.roomId);
        const snap = await getDoc(roomRef);
        if(snap.exists()){
          const data = snap.data();
          const members = Array.isArray(data.members) ? data.members : [];
          if(!members.includes(n)) members.push(n);
          await updateDoc(roomRef, { members, updatedAt: serverTimestamp() });
        }
      }
    });

    selAccent.addEventListener("change", ()=>{
      state.accent = selAccent.value;
      saveState();
      applyAccent(state.accent);
      toast("Akzent gesetzt", "good");
    });

    btnCopyCode.onclick = async ()=>{
      if(!state.roomCode) return;
      try{
        await navigator.clipboard.writeText(state.roomCode);
        toast("Code kopiert", "good");
      }catch(e){
        toast("Kopieren nicht möglich", "warn");
      }
    };

    btnLeave.onclick = async ()=>{
      if(!confirm("Raum verlassen?")) return;
      await detachAll();
      state.roomId = null;
      state.roomCode = null;
      state.roomName = null;
      saveState();
      closeModal(modalMenu);
      showWelcome();
    };

    /***********************************************************************
     * Check-in actions
     ***********************************************************************/
    btnOpenCheckin.onclick = ()=>openCheckin();
    btnCloseCheckin.onclick = ()=>closeModal(modalCheckin);
    rangeFit.oninput = ()=>sliderVal.textContent = rangeFit.value;

    function openCheckin(){
      checkinTitle.textContent = `Check-in · ${prettyDate(state.selectedDay)}`;
      checkinSubtitle.textContent = state.roomName ? state.roomName : "—";
      const existing = (window.__dayCheckins||{})[state.name];
      const val = (existing?.status==="yes" && Number.isFinite(existing.fitness)) ? existing.fitness : 7;
      rangeFit.value = String(val);
      sliderVal.textContent = String(val);
      openModal(modalCheckin);
    }

    btnSave.onclick = async ()=>{
      await setCheckin(state.selectedDay, { status:"yes", fitness: Number(rangeFit.value), atMs: Date.now() });
      closeModal(modalCheckin);
      toast("Gespeichert", "good");
    };
    btnCant.onclick = async ()=>{
      await setCheckin(state.selectedDay, { status:"no", atMs: Date.now() });
      closeModal(modalCheckin);
      toast("Abgesagt", "bad");
    };

    /***********************************************************************
     * Posts actions
     ***********************************************************************/
    btnNewPost.onclick = ()=>{
      inpPostText.value = "";
      postSubtitle.textContent = prettyDate(state.selectedDay);
      openModal(modalPost);
    };
    btnClosePost.onclick = ()=>closeModal(modalPost);

    btnPost.onclick = async ()=>{
      const t = inpPostText.value;
      if(!t.trim()){ toast("Bitte Text", "warn"); return; }
      await addPost(state.selectedDay, t);
      closeModal(modalPost);
      toast("Gepostet", "good");
    };

    btnCloseReply.onclick = ()=>closeModal(modalReply);
    btnSendReply.onclick = async ()=>{
      const t = inpReplyText.value;
      if(!t.trim()){ toast("Bitte Text", "warn"); return; }
      if(!replyingToPostId) return;
      await addReply(state.selectedDay, replyingToPostId, t);
      closeModal(modalReply);
      toast("Gesendet", "good");
      replyingToPostId = null;
    };

    /***********************************************************************
     * Room flow actions
     ***********************************************************************/
    btnCreate.onclick = async ()=>{
      const name = (inpName.value||"").trim().slice(0,24) || "Gast";
      state.name = name; saveState(); renderTop();
      await createRoomOnline(inpRoomName.value);
      closeModal(modalMenu);
    };

    btnJoin.onclick = async ()=>{
      const name = (inpName.value||"").trim().slice(0,24) || "Gast";
      state.name = name; saveState(); renderTop();

      const ok = await joinRoomByCodeOnline(inpJoinCode.value);
      if(!ok){ toast("Code nicht gefunden", "bad"); return; }

      toast("Beigetreten", "good");
      showDash();
      closeModal(modalMenu);
    };

    /***********************************************************************
     * Boot
     ***********************************************************************/
    async function boot(){
      renderTop();
      renderCalendar();
      setSelectedDay(state.selectedDay, {scroll:false});

      if(state.roomId){
        // attach room and capture members
        await attachRoomListener(state.roomId);
        // also keep members in window for KPI calculations
        const roomRef = doc(db, "rooms", state.roomId);
        onSnapshot(roomRef, (snap)=>{
          if(!snap.exists()) return;
          const data = snap.data();
          window.__roomMembers = Array.isArray(data.members) ? data.members : [];
          state.roomName = data.name || state.roomName;
          state.roomCode = data.code || state.roomCode;
          saveState();
          renderTop();
          renderMenu();
          renderDay();
        });

        await attachDayListener(state.roomId, state.selectedDay);
        await attachPostsListener(state.roomId, state.selectedDay);

        showDash();
      }else{
        showWelcome();
      }
    }

    boot().catch((e)=>{
      console.error(e);
      toast("Init Fehler (Firestore Rules?)", "bad");
      showWelcome();
    });
  </script>
</body>
</html>